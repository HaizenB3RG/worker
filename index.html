<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2563eb">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Excavator Work Timer</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            transition: direction 0.3s ease;
        }
        body[dir="rtl"] {
            font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
        }
        .container { max-width: 600px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 28px; margin-bottom: 5px; }
        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        .timer-display { text-align: center; margin-bottom: 20px; }
        .timer-display .time {
            font-size: 64px;
            font-weight: bold;
            color: #2563eb;
            font-variant-numeric: tabular-nums;
        }
        .payment-display {
            text-align: center;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
        }
        .payment-display .amount {
            font-size: 48px;
            font-weight: bold;
            color: white;
        }
        .job-info {
            background: #f8fafc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .job-info .job-name {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
        }
        .btn {
            width: 100%;
            padding: 20px;
            border: none;
            border-radius: 15px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }
        .btn-start {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }
        .btn-stop {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            margin-bottom: 15px;
        }
        .btn-pause {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        .input-group { margin-bottom: 20px; }
        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #475569;
        }
        .input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab {
            flex: 1;
            padding: 15px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            color: white;
        }
        .tab.active {
            background: white;
            color: #2563eb;
        }
        .view { display: none; }
        .view.active { display: block; }
        .today-summary {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            padding: 20px;
            border-radius: 15px;
            color: white;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        .summary-item { text-align: center; }
        .summary-item .value {
            font-size: 32px;
            font-weight: bold;
        }
        .saved-job-item {
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        .saved-job-item:hover {
            background: #e2e8f0;
        }
        .saved-job-item.selected {
            background: #dbeafe;
            border: 2px solid #2563eb;
        }
        .history-item {
            background: #f8fafc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #2563eb;
            position: relative;
        }
        .delete-history-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #fee2e2;
            color: #dc2626;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .delete-history-btn:hover {
            background: #fca5a5;
        }
        @media (max-width: 480px) {
            .timer-display .time { font-size: 48px; }
            .payment-display .amount { font-size: 36px; }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 data-i18n="app_title">🚜 Excavator Timer</h1>
            <p data-i18n="app_subtitle">Track your work time & earnings</p>
            <button onclick="toggleLanguage()" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: 600; margin-top: 10px; font-size: 14px;">
                🌐 <span id="lang-toggle">AR</span>
            </button>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('timer')" data-i18n="tab_timer">Live Timer</button>
            <button class="tab" onclick="switchTab('manual')" data-i18n="tab_manual">Manual Entry</button>
            <button class="tab" onclick="switchTab('history')" data-i18n="tab_history">History</button>
            <button class="tab" onclick="switchTab('settings')" data-i18n="tab_settings">Settings</button>
        </div>

        <div id="timer-view" class="view active">
            <div class="card">
                <div id="setup-section">
                    <h2 style="margin-bottom: 20px;" data-i18n="select_job">Select or Create Job</h2>
                    <div id="saved-jobs-list"></div>
                    <div style="text-align: center; margin: 20px 0; color: #94a3b8; font-weight: 600;" data-i18n="or_text">OR</div>
                    <div class="input-group">
                        <label data-i18n="job_site">📍 Job Site</label>
                        <input type="text" id="job-site" placeholder="e.g., Casa Marina Beach">
                    </div>
                    <div class="input-group">
                        <label data-i18n="client_name">👤 Client Name</label>
                        <input type="text" id="client-name" placeholder="e.g., Ahmed">
                    </div>
                    <div class="input-group">
                        <label data-i18n="hourly_rate">💰 Hourly Rate (MAD)</label>
                        <input type="number" id="hourly-rate" placeholder="e.g., 500">
                    </div>
                    <button class="btn btn-start" onclick="startTimer()" data-i18n="start_working">Start Working</button>
                </div>

                <div id="timer-section" style="display: none;">
                    <div class="job-info">
                        <div style="font-size: 14px; color: #64748b; margin-bottom: 5px;">📍 <span id="current-job-site">-</span></div>
                        <div class="job-name">👤 <span id="current-client-name">-</span></div>
                        <div style="color: #64748b; margin-top: 5px;">Rate: <strong id="current-rate" style="color: #2563eb;">0</strong> MAD/hour</div>
                    </div>
                    <div class="timer-display">
                        <div class="time" id="timer">00:00:00</div>
                    </div>
                    <div class="payment-display">
                        <div class="amount" id="payment">0.00 MAD</div>
                    </div>
                    <button class="btn btn-stop" onclick="stopTimer()" data-i18n="stop_save">Stop & Save</button>
                    <button class="btn btn-pause" onclick="pauseTimer()" id="pause-btn" data-i18n="pause">Pause</button>
                </div>
            </div>

            <div class="card today-summary">
                <h3 data-i18n="today_summary">📊 Today's Summary</h3>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="value" id="today-hours">0h 0m</div>
                        <div style="font-size: 12px; opacity: 0.8;" data-i18n="total_time">Total Time</div>
                    </div>
                    <div class="summary-item">
                        <div class="value" id="today-payment">0 MAD</div>
                        <div style="font-size: 12px; opacity: 0.8;" data-i18n="total_payment">Total Earned</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="manual-view" class="view">
            <div class="card">
                <h2 style="margin-bottom: 20px;" data-i18n="manual_entry_title">📝 Manual Time Entry</h2>
                <p style="color: #64748b; margin-bottom: 20px; font-size: 14px;" data-i18n="manual_entry_desc">Enter start and stop times to calculate work duration and payment</p>
                
                <div id="manual-saved-jobs" style="margin-bottom: 20px;"></div>
                
                <div style="text-align: center; margin: 20px 0; color: #94a3b8; font-weight: 600;" data-i18n="or_text">OR</div>
                
                <div class="input-group">
                    <label data-i18n="job_site">📍 Job Site</label>
                    <input type="text" id="manual-job-site" placeholder="e.g., Casa Marina Beach">
                </div>

                <div class="input-group">
                    <label data-i18n="client_name">👤 Client Name</label>
                    <input type="text" id="manual-client-name" placeholder="e.g., Ahmed">
                </div>

                <div class="input-group">
                    <label data-i18n="hourly_rate">💰 Hourly Rate (MAD)</label>
                    <input type="number" id="manual-hourly-rate" placeholder="e.g., 500">
                </div>

                <div class="input-group">
                    <label data-i18n="start_time">Start Time (24-hour format: HH:MM)</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="manual-start-time" placeholder="08:30" pattern="[0-2][0-9]:[0-5][0-9]" maxlength="5" style="flex: 1;">
                        <select id="manual-start-period" style="display: none; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; background: white; cursor: pointer;">
                            <option value="AM" data-i18n="morning">Morning (AM)</option>
                            <option value="PM" data-i18n="evening">Evening (PM)</option>
                        </select>
                    </div>
                </div>

                <div class="input-group">
                    <label data-i18n="stop_time">Stop Time (24-hour format: HH:MM)</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="manual-stop-time" placeholder="17:00" pattern="[0-2][0-9]:[0-5][0-9]" maxlength="5" style="flex: 1;">
                        <select id="manual-stop-period" style="display: none; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; background: white; cursor: pointer;">
                            <option value="AM" data-i18n="morning">Morning (AM)</option>
                            <option value="PM" data-i18n="evening">Evening (PM)</option>
                        </select>
                    </div>
                </div>

                <div id="manual-result" style="display: none; background: #f0fdf4; border: 2px solid #22c55e; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="text-align: center;">
                        <div style="font-size: 14px; color: #166534; margin-bottom: 10px;" data-i18n="duration_payment">Duration & Payment</div>
                        <div style="font-size: 32px; font-weight: bold; color: #15803d;" id="manual-duration">0h 0m</div>
                        <div style="font-size: 36px; font-weight: bold; color: #15803d; margin-top: 10px;" id="manual-payment">0.00 MAD</div>
                    </div>
                </div>

                <button class="btn btn-start" onclick="calculateManual()" data-i18n="calculate">Calculate</button>
                <button class="btn" style="background: #e2e8f0; color: #475569; margin-top: 10px;" onclick="saveManual()" data-i18n="save_history">Save to History</button>
            </div>
        </div>

        <div id="history-view" class="view">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 data-i18n="work_history">Work History</h2>
                    <button class="btn" style="background: #f59e0b; color: white; padding: 12px 20px; width: auto; font-size: 14px;" onclick="clearUnsentSessions()" data-i18n="clear_unsent_sessions">🗑️ Clear Unsent Sessions</button>
                </div>
                <div id="history-list">
                    <p style="text-align: center; color: #94a3b8; padding: 40px;" data-i18n="no_history">No history yet</p>
                </div>
            </div>
        </div>

        <div id="settings-view" class="view">
            <div class="card">
                <h2 style="margin-bottom: 20px;" data-i18n="worker_settings">⚙️ Worker Settings</h2>
                
                <div class="input-group">
                    <label data-i18n="your_name">Your Name</label>
                    <input type="text" id="worker-name" placeholder="Enter your name">
                    <p style="font-size: 12px; color: #64748b; margin-top: 5px;" data-i18n="name_appears">This name will appear in admin reports</p>
                </div>

                <button class="btn btn-start" onclick="saveWorkerName()" data-i18n="save_name">Save Name</button>

                <div style="margin-top: 30px; padding: 20px; background: #f8fafc; border-radius: 10px; border: 2px solid #cbd5e1;">
                    <h3 style="color: #475569; margin-bottom: 15px;">🕐 <span data-i18n="time_format">Time Format</span></h3>
                    <div style="display: flex; gap: 10px;">
                        <button id="time-format-24h" onclick="setTimeFormat('24h')" style="flex: 1; padding: 12px; border: 2px solid #2563eb; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #2563eb; color: white;">
                            <span data-i18n="time_format_24h">24-hour (14:30)</span>
                        </button>
                        <button id="time-format-12h" onclick="setTimeFormat('12h')" style="flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: white; color: #64748b;">
                            <span data-i18n="time_format_12h">12-hour (2:30 PM)</span>
                        </button>
                    </div>
                </div>

                <div style="margin-top: 30px; padding: 20px; background: #f0fdf4; border-radius: 10px; border: 2px solid #22c55e;">
                    <h3 style="color: #166534; margin-bottom: 10px;" data-i18n="submit_sessions">📤 Submit Work Sessions</h3>
                    <p style="font-size: 14px; color: #166534; margin-bottom: 15px;" data-i18n="send_unsent">Send unsent work sessions to admin</p>
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #166534;" data-i18n="unsent_sessions">Unsent Sessions:</strong>
                        <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 8px;">
                            <div id="submit-summary"></div>
                        </div>
                    </div>
                    <button class="btn btn-start" onclick="submitToAdmin()" data-i18n="submit_admin">Submit to Admin</button>
                </div>

                <div id="submission-history" style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: #1e293b; margin: 0;" data-i18n="submission_history">📋 Submission History</h3>
                        <button class="btn" style="background: #dc2626; color: white; padding: 10px 16px; width: auto; font-size: 13px; font-weight: 600;" onclick="clearSubmissionHistory()" data-i18n="clear_submission_history">🗑️ Clear Submission History</button>
                    </div>
                    <div id="submission-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Payment Modal -->
    <div id="paymentModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 20px; padding: 30px; max-width: 400px; width: 90%; margin: 20px;">
            <h2 style="margin-bottom: 20px; color: #1e293b;" data-i18n="add_payment">💰 Add Payment</h2>
            
            <div id="paymentModalInfo" style="background: #f8fafc; padding: 15px; border-radius: 10px; margin-bottom: 20px; font-size: 14px; color: #64748b;">
            </div>
            
            <div class="input-group">
                <label for="paymentAmount" data-i18n="payment_amount">Payment Amount (MAD)</label>
                <input type="number" id="paymentAmount" placeholder="Enter amount received" step="0.01" min="0" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
            </div>
            
            <div id="markFullyPaidSection" style="display: none; margin-top: 15px; padding: 12px; background: #fef3c7; border: 2px solid #fbbf24; border-radius: 10px;">
                <label style="display: flex; align-items: center; cursor: pointer; font-size: 14px; color: #92400e;">
                    <input type="checkbox" id="markFullyPaidCheckbox" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                    <span>
                        <strong data-i18n="mark_fully_paid">Mark as fully paid</strong><br>
                        <span style="font-size: 12px; color: #b45309;" data-i18n="client_cannot_pay_more">(Client cannot pay the remaining amount)</span>
                    </span>
                </label>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="closePaymentModal()" style="flex: 1; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: white; color: #64748b;" data-i18n="cancel">Cancel</button>
                <button onclick="addPayment()" style="flex: 1; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: #10b981; color: white;" data-i18n="add_payment">Add Payment</button>
            </div>
        </div>
    </div>

    <!-- Device Registration Screen -->
    <div id="registrationScreen" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 3000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 20px; padding: 40px; max-width: 450px; width: 90%; margin: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); text-align: center;">
            <div style="font-size: 64px; margin-bottom: 20px;">🔐</div>
            <h2 style="font-size: 24px; color: #1e293b; margin-bottom: 10px;" data-i18n="device_registration">Device Registration</h2>
            <p style="color: #64748b; font-size: 14px; margin-bottom: 30px; line-height: 1.6;">
                <span data-i18n="registration_desc">Enter your registration code to access the app. Contact your admin if you don't have a code.</span>
            </p>
            
            <div style="margin-bottom: 20px;">
                <input type="text" id="registrationCodeInput" placeholder="Enter registration code" 
                    style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; text-align: center; text-transform: uppercase; font-family: monospace; letter-spacing: 2px;">
            </div>
            
            <div id="registrationError" style="display: none; background: #fee2e2; color: #dc2626; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 14px;"></div>
            
            <button id="registerDeviceBtn" onclick="registerDevice()" 
                style="width: 100%; padding: 18px; border: none; border-radius: 10px; font-size: 18px; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; transition: transform 0.2s;">
                <span data-i18n="register_device">Register This Device</span>
            </button>
            
            <div id="registrationLoading" style="display: none; margin-top: 20px; color: #64748b; font-size: 14px;">
                <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #e2e8f0; border-top-color: #2563eb; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <span style="margin-left: 10px;">Registering device...</span>
            </div>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="customAlertModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 4000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 20px; padding: 30px; max-width: 400px; width: 90%; margin: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div id="customAlertIcon" style="text-align: center; font-size: 48px; margin-bottom: 15px;">ℹ️</div>
            <div id="customAlertMessage" style="font-size: 16px; color: #1e293b; text-align: center; margin-bottom: 25px; line-height: 1.6; white-space: pre-wrap;"></div>
            <button id="customAlertOkBtn" style="width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); color: white;">OK</button>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="customConfirmModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 4000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 20px; padding: 30px; max-width: 400px; width: 90%; margin: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div id="customConfirmIcon" style="text-align: center; font-size: 48px; margin-bottom: 15px;">❓</div>
            <div id="customConfirmMessage" style="font-size: 16px; color: #1e293b; text-align: center; margin-bottom: 25px; line-height: 1.6; white-space: pre-wrap;"></div>
            <div style="display: flex; gap: 10px;">
                <button id="customConfirmCancelBtn" style="flex: 1; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: white; color: #64748b;">Cancel</button>
                <button id="customConfirmOkBtn" style="flex: 1; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;">OK</button>
            </div>
        </div>
    </div>

    <!-- Edit Session Modal -->
    <div id="editSessionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; overflow-y: auto;">
        <div style="background: white; border-radius: 20px; padding: 30px; max-width: 500px; width: 90%; margin: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <h2 style="margin-bottom: 20px; color: #1e293b; text-align: center;">✏️ <span data-i18n="edit_session">Edit Session</span></h2>
            
            <div class="input-group">
                <label data-i18n="job_site">📍 Job Site</label>
                <input type="text" id="edit-job-site" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
            </div>
            
            <div class="input-group">
                <label data-i18n="client_name">👤 Client Name</label>
                <input type="text" id="edit-client-name" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
            </div>
            
            <div class="input-group">
                <label data-i18n="hourly_rate">💰 Hourly Rate (MAD)</label>
                <input type="number" id="edit-hourly-rate" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
            </div>
            
            <div class="input-group">
                <label data-i18n="start_time">🕐 Start Time (24h format: HH:MM)</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="edit-start-time" placeholder="08:30" pattern="[0-2][0-9]:[0-5][0-9]" maxlength="5" style="flex: 1; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
                    <select id="edit-start-period" style="display: none; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; background: white; cursor: pointer;">
                        <option value="AM" data-i18n="morning">Morning (AM)</option>
                        <option value="PM" data-i18n="evening">Evening (PM)</option>
                    </select>
                </div>
            </div>
            
            <div class="input-group">
                <label data-i18n="stop_time">🕐 Stop Time (24h format: HH:MM)</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="edit-stop-time" placeholder="17:00" pattern="[0-2][0-9]:[0-5][0-9]" maxlength="5" style="flex: 1; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
                    <select id="edit-stop-period" style="display: none; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; background: white; cursor: pointer;">
                        <option value="AM" data-i18n="morning">Morning (AM)</option>
                        <option value="PM" data-i18n="evening">Evening (PM)</option>
                    </select>
                </div>
            </div>
            
            <div id="edit-calculated-result" style="display: none; background: #f0fdf4; border: 2px solid #22c55e; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                <div style="font-size: 14px; color: #166534; margin-bottom: 5px;">Duration & Payment</div>
                <div style="font-size: 24px; font-weight: bold; color: #15803d;" id="edit-duration-display">0h 0m</div>
                <div style="font-size: 28px; font-weight: bold; color: #15803d; margin-top: 5px;" id="edit-payment-display">0 MAD</div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="closeEditSessionModal()" style="flex: 1; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: white; color: #64748b;" data-i18n="cancel">Cancel</button>
                <button onclick="saveEditedSession()" style="flex: 1; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;" data-i18n="save_changes">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Price Adjustment Modal -->
    <div id="priceAdjustModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 20px; padding: 30px; max-width: 450px; width: 90%; margin: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <h2 style="margin-bottom: 20px; color: #1e293b; text-align: center;">💰 <span data-i18n="adjust_price">Adjust Price</span></h2>
            
            <div id="priceAdjustInfo" style="background: #f8fafc; padding: 15px; border-radius: 10px; margin-bottom: 20px; font-size: 14px; color: #64748b;">
            </div>
            
            <div class="input-group">
                <label data-i18n="adjusted_price">Adjusted Price (MAD)</label>
                <input type="number" id="adjustedPriceInput" placeholder="Enter new price" step="0.01" min="0" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="closePriceAdjustModal()" style="flex: 1; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: white; color: #64748b;" data-i18n="cancel">Cancel</button>
                <button onclick="resetPrice()" style="flex: 1; padding: 15px; border: 2px solid #f59e0b; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: white; color: #f59e0b;" data-i18n="reset_price">Reset</button>
                <button onclick="applyPriceAdjustment()" style="flex: 1; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;" data-i18n="apply_discount">Apply</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, set, onValue, update, get, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDR2jvmeJyD3pLoGZiRQ6CXqy86zVZeB3o",
            authDomain: "excavator-timer.firebaseapp.com",
            databaseURL: "https://excavator-timer-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "excavator-timer",
            storageBucket: "excavator-timer.firebasestorage.app",
            messagingSenderId: "983543822117",
            appId: "1:983543822117:web:b55c1a232ef0fb96f8cccc"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);

        // Make Firebase accessible globally
        window.firebaseDB = database;
        window.firebaseRef = ref;
        window.firebasePush = push;
        window.firebaseSet = set;
        window.firebaseOnValue = onValue;
        window.firebaseUpdate = update;
        window.firebaseGet = get;
        window.firebaseRemove = remove;
        window.firebaseAuth = auth;

        console.log('🔥 Firebase initialized in worker app!');
        console.log('📱 Worker App Version: 4.2.1 (Separate Clear Buttons)');
        console.log('🕐 Loaded at:', new Date().toLocaleString());

        // ========================================
        // 🔐 AUTHENTICATION & DEVICE REGISTRATION
        // ========================================
        
        let currentUser = null;
        let isDeviceRegistered = false;

        // Check if device is registered (stored locally)
        function checkDeviceRegistration() {
            const deviceId = localStorage.getItem('deviceId');
            const deviceRole = localStorage.getItem('deviceRole');
            
            console.log('🔍 Checking device registration:', { deviceId, deviceRole });
            
            if (deviceId && deviceRole) {
                return { deviceId, deviceRole };
            }
            return null;
        }

        // Show/hide registration screen
        function showRegistrationScreen() {
            document.getElementById('registrationScreen').style.display = 'flex';
            document.querySelector('.container').style.display = 'none';
        }

        function hideRegistrationScreen() {
            document.getElementById('registrationScreen').style.display = 'none';
            document.querySelector('.container').style.display = 'block';
        }

        // Register device with code
        window.registerDevice = async function() {
            console.log('🔵 [1] registerDevice() called');
            const codeInput = document.getElementById('registrationCodeInput');
            const code = codeInput.value.trim().toUpperCase();
            const errorDiv = document.getElementById('registrationError');
            const loadingDiv = document.getElementById('registrationLoading');
            const registerBtn = document.getElementById('registerDeviceBtn');
            
            console.log('🔵 [2] Code entered:', code);
            
            if (!code) {
                errorDiv.textContent = 'Please enter a registration code';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Show loading
            loadingDiv.style.display = 'block';
            registerBtn.disabled = true;
            errorDiv.style.display = 'none';
            
            console.log('🔵 [3] Loading indicator shown, checking Firebase...');
            
            try {
                // Check if code exists and is valid
                const codeRef = ref(database, 'registrationCodes/' + code);
                console.log('🔵 [4] Fetching code from Firebase...');
                const codeSnapshot = await get(codeRef);
                console.log('🔵 [5] Code snapshot received:', codeSnapshot.exists());
                
                if (!codeSnapshot.exists()) {
                    throw new Error('Invalid registration code');
                }
                
                const codeData = codeSnapshot.val();
                console.log('🔵 [6] Code data:', codeData);
                
                // Check if code is for worker role
                if (codeData.type !== 'worker') {
                    throw new Error('This code is not valid for worker app');
                }
                
                // Get worker name from registration code
                const workerName = codeData.workerName || null;
                console.log('🔵 [7] Worker name from code:', workerName);
                
                // Get current user's UID (from anonymous auth)
                if (!currentUser) {
                    throw new Error('Authentication error. Please refresh the page.');
                }
                
                const deviceId = currentUser.uid;
                console.log('🔵 [8] Device ID:', deviceId);
                
                // If worker name exists in code, ask for confirmation
                if (workerName) {
                    console.log('🔵 [9] Showing confirmation for existing worker...');
                    const confirmMsg = `This code is registered to: ${workerName}\n\nRegister this device for ${workerName}?`;
                    const confirmed = await customConfirm(confirmMsg, '👷');
                    console.log('🔵 [10] Confirmation result:', confirmed);
                    
                    if (!confirmed) {
                        loadingDiv.style.display = 'none';
                        registerBtn.disabled = false;
                        return;
                    }
                    
                    console.log(`✅ Registering device for existing worker: ${workerName}`);
                } else {
                    // First time registration - ask for worker name
                    console.log('🔵 [11] No worker name found, asking for name...');
                    const newWorkerName = await customPrompt('Please enter your name:', '👷');
                    console.log('🔵 [12] Name entered:', newWorkerName);
                    if (!newWorkerName || !newWorkerName.trim()) {
                        loadingDiv.style.display = 'none';
                        registerBtn.disabled = false;
                        throw new Error('Worker name is required');
                    }
                    
                    // Save worker name to registration code
                    await update(codeRef, {
                        workerName: newWorkerName.trim(),
                        firstUsedAt: Date.now()
                    });
                    
                    console.log(`✅ First time registration for worker: ${newWorkerName.trim()}`);
                }
                
                const finalWorkerName = workerName || (await get(codeRef)).val().workerName;
                
                // Register device in Firebase (linked to worker)
                const deviceRef = ref(database, 'registeredDevices/' + deviceId);
                await set(deviceRef, {
                    role: 'worker',
                    workerName: finalWorkerName,
                    registeredAt: Date.now(),
                    lastActive: Date.now(),
                    registrationCode: code,
                    deviceInfo: navigator.userAgent
                });
                
                // Add device to worker's device list
                const workerDevicesRef = ref(database, `workers/${finalWorkerName}/devices/${deviceId}`);
                await set(workerDevicesRef, {
                    deviceId: deviceId,
                    registeredAt: Date.now(),
                    lastActive: Date.now()
                });
                
                // Save to localStorage
                localStorage.setItem('deviceId', deviceId);
                localStorage.setItem('deviceRole', 'worker');
                localStorage.setItem('workerName', finalWorkerName);
                
                console.log('✅ Device registered successfully!', { deviceId, role: 'worker', workerName: finalWorkerName });
                
                // Load existing worker data from Firebase
                await loadWorkerDataFromFirebase(finalWorkerName);
                
                // Hide registration screen and show app
                hideRegistrationScreen();
                await customAlert(`✅ Welcome back, ${finalWorkerName}!\n\nDevice registered successfully!`, '🎉');
                
                // Initialize app
                initApp();
                
            } catch (error) {
                console.error('❌ Registration error:', error);
                errorDiv.textContent = error.message || 'Registration failed. Please try again.';
                errorDiv.style.display = 'block';
                loadingDiv.style.display = 'none';
                registerBtn.disabled = false;
            }
        };
        
        // Load existing worker data from Firebase on new device registration
        async function loadWorkerDataFromFirebase(workerName) {
            try {
                console.log(`📥 Loading existing data for worker: ${workerName}`);
                
                // Initialize data structure
                let data = loadData();
                data.workerName = workerName;
                
                // Ensure arrays exist
                if (!data.history) data.history = [];
                if (!data.submissions) data.submissions = [];
                if (!data.jobs) data.jobs = [];
                
                // Load drafts (unsent sessions)
                const draftsRef = ref(database, `drafts/${workerName}`);
                const draftsSnapshot = await get(draftsRef);
                
                if (draftsSnapshot.exists()) {
                    const firebaseDrafts = draftsSnapshot.val();
                    const draftsArray = Object.values(firebaseDrafts);
                    
                    console.log(`📦 Found ${draftsArray.length} unsent sessions in Firebase`);
                    
                    // Merge with local history (avoid duplicates)
                    const existingTimestamps = data.history.map(h => h.timestamp);
                    draftsArray.forEach(draft => {
                        if (!existingTimestamps.includes(draft.timestamp)) {
                            data.history.push(draft);
                        }
                    });
                }
                
                // Load submissions (sent sessions) - we need to check submissions in Firebase
                const submissionsRef = ref(database, 'submissions');
                const submissionsSnapshot = await get(submissionsRef);
                
                if (submissionsSnapshot.exists()) {
                    const allSubmissions = submissionsSnapshot.val();
                    const workerSubmissions = [];
                    
                    // Filter submissions for this worker
                    Object.keys(allSubmissions).forEach(key => {
                        const submission = allSubmissions[key];
                        if (submission.workerName === workerName) {
                            workerSubmissions.push({
                                ...submission,
                                firebaseKey: key
                            });
                        }
                    });
                    
                    console.log(`📊 Found ${workerSubmissions.length} submitted sessions in Firebase`);
                    
                    // Replace local submissions with Firebase data
                    data.submissions = workerSubmissions;
                }
                
                // Save to localStorage
                saveData(data);
                
                console.log('✅ Worker data loaded and synced to localStorage');
                console.log(`   - History: ${data.history.length} sessions`);
                console.log(`   - Submissions: ${data.submissions.length} submissions`);
                
            } catch (error) {
                console.error('❌ Error loading worker data:', error);
                // Don't throw error - continue with empty data
            }
        }

        // Authentication state change listener
        onAuthStateChanged(auth, async (user) => {
            console.log('🔐 Auth state changed:', user ? 'Signed in' : 'Signed out');
            
            if (user) {
                currentUser = user;
                console.log('👤 User UID:', user.uid);
                
                // Check if device is registered
                const registration = checkDeviceRegistration();
                
                if (registration) {
                    // Device is registered - verify in Firebase
                    try {
                        const deviceRef = ref(database, 'registeredDevices/' + registration.deviceId);
                        const deviceSnapshot = await get(deviceRef);
                        
                        if (deviceSnapshot.exists()) {
                            const deviceData = deviceSnapshot.val();
                            
                            if (deviceData.role === 'worker') {
                                console.log('✅ Device verified as registered worker');
                                console.log('👷 Worker:', deviceData.workerName);
                                isDeviceRegistered = true;
                                
                                // Ensure worker name is in localStorage
                                if (deviceData.workerName && !localStorage.getItem('workerName')) {
                                    localStorage.setItem('workerName', deviceData.workerName);
                                }
                                
                                // Ensure worker name is in data structure
                                const currentData = loadData();
                                if (!currentData.workerName && deviceData.workerName) {
                                    currentData.workerName = deviceData.workerName;
                                    saveData(currentData);
                                }
                                
                                // Update last active
                                await update(deviceRef, { lastActive: Date.now() });
                                
                                // Hide registration screen and show app
                                hideRegistrationScreen();
                                
                                // Initialize app
                                initApp();
                            } else {
                                console.error('❌ Device role mismatch');
                                localStorage.clear();
                                showRegistrationScreen();
                            }
                        } else {
                            console.error('❌ Device not found in Firebase');
                            localStorage.removeItem('deviceId');
                            localStorage.removeItem('deviceRole');
                            localStorage.removeItem('workerName');
                            showRegistrationScreen();
                        }
                    } catch (error) {
                        console.error('❌ Device verification error:', error);
                        showRegistrationScreen();
                    }
                } else {
                    // Device not registered - show registration screen
                    console.log('⚠️ Device not registered locally');
                    setTimeout(() => showRegistrationScreen(), 100);
                }
            } else {
                // Not signed in - sign in anonymously
                console.log('🔄 Signing in anonymously...');
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error('❌ Anonymous sign-in error:', error);
                    await customAlert('Authentication error. Please refresh the page.', '❌');
                }
            }
        });

        // ========================================
        // 📦 FIREBASE DRAFTS MANAGEMENT
        // ========================================
        
        let isSyncing = false;
        let syncIndicator = null;
        
        // Get worker name for drafts path
        function getWorkerName() {
            const data = loadData();
            return data.workerName || 'Unknown';
        }
        
        // Save session draft to Firebase
        window.saveDraftToFirebase = async function(session) {
            try {
                isSyncing = true;
                showSyncIndicator('syncing');
                
                const workerName = getWorkerName();
                const draftRef = ref(database, `drafts/${workerName}/${session.timestamp}`);
                
                await window.firebaseSet(draftRef, {
                    ...session,
                    workerName: workerName,
                    lastModified: Date.now(),
                    deviceId: localStorage.getItem('deviceId') || 'unknown'
                });
                
                console.log('☁️ Draft saved to Firebase:', session.timestamp);
                showSyncIndicator('synced');
                isSyncing = false;
                
                return true;
            } catch (error) {
                console.error('❌ Failed to save draft to Firebase:', error);
                showSyncIndicator('error');
                isSyncing = false;
                return false;
            }
        };
        
        // Delete draft from Firebase
        window.deleteDraftFromFirebase = async function(timestamp) {
            try {
                const workerName = getWorkerName();
                const draftRef = ref(database, `drafts/${workerName}/${timestamp}`);
                await window.firebaseRemove(draftRef);
                console.log('🗑️ Draft deleted from Firebase:', timestamp);
            } catch (error) {
                console.error('❌ Failed to delete draft from Firebase:', error);
            }
        };
        
        // Load drafts from Firebase (recovery)
        async function loadDraftsFromFirebase() {
            try {
                console.log('📥 Loading drafts from Firebase...');
                const workerName = getWorkerName();
                const draftsRef = ref(database, `drafts/${workerName}`);
                
                return new Promise((resolve) => {
                    window.firebaseOnValue(draftsRef, (snapshot) => {
                        if (snapshot.exists()) {
                            const firebaseDrafts = snapshot.val();
                            const draftsArray = Object.values(firebaseDrafts);
                            console.log(`☁️ Found ${draftsArray.length} drafts in Firebase`);
                            resolve(draftsArray);
                        } else {
                            console.log('📭 No drafts found in Firebase');
                            resolve([]);
                        }
                    }, { onlyOnce: true });
                });
            } catch (error) {
                console.error('❌ Failed to load drafts from Firebase:', error);
                return [];
            }
        }
        
        // Sync indicator UI
        function showSyncIndicator(status) {
            if (!syncIndicator) {
                syncIndicator = document.createElement('div');
                syncIndicator.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: white; padding: 10px 15px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; display: flex; align-items: center; gap: 8px; font-size: 12px; transition: all 0.3s;';
                document.body.appendChild(syncIndicator);
            }
            
            const icons = {
                syncing: '🔄',
                synced: '☁️✅',
                error: '⚠️',
                offline: '📴'
            };
            
            const messages = {
                syncing: 'Syncing...',
                synced: 'Synced',
                error: 'Sync Error',
                offline: 'Offline'
            };
            
            const colors = {
                syncing: '#3b82f6',
                synced: '#10b981',
                error: '#ef4444',
                offline: '#f59e0b'
            };
            
            syncIndicator.innerHTML = `<span style="font-size: 16px;">${icons[status]}</span><span style="color: ${colors[status]}; font-weight: 600;">${messages[status]}</span>`;
            syncIndicator.style.display = 'flex';
            
            if (status === 'synced') {
                setTimeout(() => {
                    syncIndicator.style.display = 'none';
                }, 3000);
            }
        }
        
        // Recover data from Firebase on app start
        async function recoverDataFromFirebase() {
            try {
                console.log('🔄 Checking for data recovery...');
                const data = loadData();
                const firebaseDrafts = await loadDraftsFromFirebase();
                
                if (firebaseDrafts.length > 0) {
                    console.log(`📦 Recovering ${firebaseDrafts.length} drafts from Firebase...`);
                    
                    // Merge Firebase drafts with local data
                    const localTimestamps = data.history.map(h => h.timestamp);
                    let recovered = 0;
                    
                    firebaseDrafts.forEach(draft => {
                        // Only add if not already in local history
                        if (!localTimestamps.includes(draft.timestamp)) {
                            data.history.push(draft);
                            recovered++;
                        }
                    });
                    
                    if (recovered > 0) {
                        saveData(data);
                        renderHistory();
                        updateSubmitSummary();
                        console.log(`✅ Recovered ${recovered} sessions from Firebase!`);
                        await customAlert(`✅ Recovered ${recovered} unsaved session(s) from cloud backup!`, 'ℹ️');
                    } else {
                        console.log('✅ All drafts already synced');
                    }
                } else {
                    console.log('✅ No recovery needed');
                }
            } catch (error) {
                console.error('❌ Recovery error:', error);
            }
        }
        
        // ========================================
        // 🚀 MAIN APP INITIALIZATION
        // ========================================
        
        function initApp() {
            console.log('🚀 Initializing app...');
            
            // Check if we need to recover data from Firebase
            recoverDataFromFirebase();
            
            // ========================================
            // 🔥 REAL-TIME LISTENER: DRAFTS (UNSENT SESSIONS)
            // ========================================
            const workerName = getWorkerName();
            const draftsRef = ref(database, `drafts/${workerName}`);
            
            console.log('👂 Setting up real-time listener for drafts...');
            
            onValue(draftsRef, (snapshot) => {
                console.log('🔥 Firebase drafts changed!');
                
                if (snapshot.exists()) {
                    const firebaseDrafts = snapshot.val();
                    const draftsArray = Object.values(firebaseDrafts);
                    console.log(`☁️ Firebase has ${draftsArray.length} drafts`);
                    
                    const data = loadData();
                    const localTimestamps = data.history.map(h => h.timestamp);
                    let added = 0;
                    let removed = 0;
                    
                    // Add new drafts from Firebase that don't exist locally
                    draftsArray.forEach(draft => {
                        if (!localTimestamps.includes(draft.timestamp)) {
                            console.log('➕ Adding new draft from Firebase:', draft.timestamp);
                            data.history.push(draft);
                            added++;
                        }
                    });
                    
                    // Remove local drafts that don't exist in Firebase (were submitted on another device)
                    const firebaseTimestamps = draftsArray.map(d => d.timestamp);
                    data.history = data.history.filter(h => {
                        if (h.sent === false && !firebaseTimestamps.includes(h.timestamp)) {
                            console.log('➖ Removing draft (submitted on another device):', h.timestamp);
                            removed++;
                            return false;
                        }
                        return true;
                    });
                    
                    if (added > 0 || removed > 0) {
                        saveData(data);
                        renderHistory();
                        updateSubmitSummary();
                        updateTodaySummary();
                        console.log(`✅ Synced: +${added} added, -${removed} removed`);
                    }
                } else {
                    // No drafts in Firebase - remove all unsent sessions locally
                    console.log('📭 No drafts in Firebase');
                    const data = loadData();
                    const beforeCount = data.history.filter(h => h.sent === false).length;
                    
                    if (beforeCount > 0) {
                        data.history = data.history.filter(h => h.sent !== false);
                        saveData(data);
                        renderHistory();
                        updateSubmitSummary();
                        updateTodaySummary();
                        console.log(`✅ Removed ${beforeCount} unsent sessions (submitted on another device)`);
                    }
                }
            });
            
            // ========================================
            // 🔥 REAL-TIME LISTENER: SUBMISSIONS
            // ========================================
            const submissionsRef = ref(database, 'submissions');
            
            console.log('👂 Setting up real-time listener for submissions...');
            
            onValue(submissionsRef, (snapshot) => {
                console.log('🔥 Firebase submissions changed!');
                
                if (snapshot.exists()) {
                    const firebaseData = snapshot.val();
                    const data = loadData();
                    
                    // Sync submissions from Firebase
                    const firebaseSubmissions = Object.values(firebaseData).filter(sub => 
                        sub.workerName === workerName
                    );
                    
                    console.log(`☁️ Firebase has ${firebaseSubmissions.length} submissions for ${workerName}`);
                    
                    // Update local submissions
                    if (!data.submissions) data.submissions = [];
                    
                    const localTimestamps = data.submissions.map(s => s.timestamp);
                    let addedSubs = 0;
                    let updatedSubs = 0;
                    
                    firebaseSubmissions.forEach(firebaseSub => {
                        const localIndex = data.submissions.findIndex(s => s.timestamp === firebaseSub.timestamp);
                        
                        if (localIndex === -1) {
                            // New submission from another device
                            console.log('➕ Adding new submission from Firebase:', firebaseSub.timestamp);
                            data.submissions.push(firebaseSub);
                            addedSubs++;
                        } else {
                            // Update existing submission (status, payments, etc.)
                            const localSub = data.submissions[localIndex];
                            if (JSON.stringify(localSub) !== JSON.stringify(firebaseSub)) {
                                console.log('🔄 Updating submission from Firebase:', firebaseSub.timestamp);
                                data.submissions[localIndex] = firebaseSub;
                                updatedSubs++;
                            }
                        }
                    });
                    
                    if (addedSubs > 0 || updatedSubs > 0) {
                        saveData(data);
                        renderSubmissionHistory();
                        console.log(`✅ Submissions synced: +${addedSubs} added, ${updatedSubs} updated`);
                    }
                }
            });
        } // End of initApp()

        // Note: initApp() will be called automatically after authentication succeeds
    </script>

    <script>
        // Show notification when status changes to approved
        function showApprovalNotification() {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('✅ Work Approved!', {
                    body: 'Your submitted work has been approved by admin.',
                    icon: 'https://via.placeholder.com/192/667eea/ffffff.png?text=ET'
                });
            }
        }
    </script>

    <script>
        // ========================================
        // 🌐 LANGUAGE SYSTEM (MUST BE FIRST!)
        // ========================================
        
        let currentLang = localStorage.getItem('language') || 'en';
        
        const translations = {
            en: {
                app_title: "🚜 Excavator Timer",
                app_subtitle: "Track your work time & earnings",
                tab_timer: "Live Timer",
                tab_manual: "Manual Entry",
                tab_history: "History",
                tab_settings: "Settings",
                start: "Start",
                stop: "Stop",
                resume: "Resume",
                calculate: "Calculate",
                save_history: "Save to History",
                submit_admin: "Submit to Admin",
                add_payment: "Add Payment",
                clear_all: "Clear All History",
                delete: "Delete",
                cancel: "Cancel",
                confirm: "Confirm",
                job_site: "📍 Job Site",
                client_name: "👤 Client Name",
                hourly_rate: "💰 Hourly Rate (MAD)",
                worker_name: "Worker Name",
                start_time: "Start Time",
                stop_time: "Stop Time",
                pending: "Pending",
                approved: "Approved",
                unpaid: "Unpaid",
                partially_paid: "Partially Paid",
                fully_paid: "Fully Paid",
                select_job: "Select or Create Job",
                or_text: "OR",
                saved_jobs: "Saved Jobs",
                no_saved_jobs: "No saved jobs yet",
                start_working: "Start Working",
                stop_save: "Stop & Save",
                pause: "Pause",
                timer_running: "Timer Running",
                timer_paused: "Timer Paused",
                current_job: "Current Job",
                duration: "Duration",
                payment: "Payment",
                today_summary: "📊 Today's Summary",
                total_time: "Total Time",
                total_payment: "Total Payment",
                manual_entry_title: "📝 Manual Time Entry",
                manual_entry_desc: "Enter start and stop times to calculate work duration and payment",
                duration_payment: "Duration & Payment",
                work_history: "Work History",
                no_history: "No history yet",
                at: "at",
                worker_settings: "Worker Settings",
                your_name: "Your Name",
                name_appears: "This name will appear in admin reports",
                save_name: "Save Name",
                submit_sessions: "Submit Work Sessions",
                send_unsent: "Send unsent work sessions to admin",
                unsent_sessions: "Unsent Sessions:",
                total_hours: "Total Hours:",
                no_sessions: "No sessions to send",
                submission_history: "Submission History",
                no_submissions: "No submissions yet",
                waiting_approval: "Waiting for admin approval",
                approved_by: "Approved by admin",
                paid: "Paid:",
                remaining: "Remaining:",
                payment_history: "Payment History",
                payments: "payments",
                sessions: "sessions",
                session: "session",
                client: "Client:",
                total_amount: "Total Amount:",
                already_paid: "Already Paid:",
                payment_amount: "Payment Amount (MAD):",
                device_registration: "Device Registration",
                registration_desc: "Enter your registration code to access the app. Contact your admin if you don't have a code.",
                register_device: "Register This Device",
                edit: "Edit",
                edit_session: "Edit Session",
                save_changes: "Save Changes",
                original_price: "Original Price:",
                adjusted_price: "Adjusted Price:",
                time_format: "Time Format",
                time_format_24h: "24-hour (14:30)",
                time_format_12h: "12-hour (2:30 PM)",
                adjust_price: "Adjust Price",
                discount_reason: "Discount/Adjustment Reason:",
                apply_discount: "Apply Adjustment",
                reset_price: "Reset to Original",
                morning: "Morning (AM)",
                evening: "Evening (PM)",
                mark_fully_paid: "Mark as fully paid",
                client_cannot_pay_more: "(Client cannot pay the remaining amount)",
                confirm_full_payment: "Client can only pay {amount} MAD?",
                remaining_unpayable: "Remaining {amount} MAD will be marked as unpayable.",
                worker_marked_paid: "Worker marked as fully paid",
                cannot_pay_remaining: "Client cannot pay remaining {amount} MAD",
                clear_unsent_sessions: "Clear Unsent Sessions",
                clear_submission_history: "Clear Submission History",
                confirm_clear_unsent: "Delete all unsent work sessions? This cannot be undone!",
                confirm_clear_submissions: "⚠️ WARNING: Delete ALL submission history?\n\nThis will permanently delete:\n• All submitted sessions\n• All payment records\n• All work history\n\nThis action CANNOT be undone!\n\nAre you absolutely sure?"
            },
            ar: {
                app_title: "مؤقت عمل الحفارة 🚜",
                app_subtitle: "تتبع وقت عملك وأرباحك",
                tab_timer: "المؤقّت المباشر",
                tab_manual: "إدخال يدوي",
                tab_history: "السجل",
                tab_settings: "الإعدادات",
                start: "بدء",
                stop: "إيقاف",
                resume: "استئناف",
                calculate: "حساب",
                save_history: "حفظ في السجل",
                submit_admin: "إرسال البيانات",
                add_payment: "إضافة مبلغ",
                clear_all: "مسح كل السجل",
                delete: "حذف",
                cancel: "إلغاء",
                confirm: "تأكيد",
                job_site: "📍 موقع العمل",
                client_name: "👤 إسم الزبون",
                hourly_rate: "💰 الأجر بالساعة (درهم)",
                worker_name: "اسم المستخدم",
                start_time: "وقت البدء",
                stop_time: "وقت الانتهاء",
                pending: "قيد المراجعة",
                approved: "مُعتمد",
                unpaid: "غير مدفوع",
                partially_paid: "مدفوع جزئيًا",
                fully_paid: "مدفوع بالكامل",
                select_job: "اختر أو أنشئ عمل",
                or_text: "أو",
                saved_jobs: "الأعمال المحفوظة",
                no_saved_jobs: "لا توجد أعمال محفوظة بعد",
                start_working: "بدء العمل",
                stop_save: "إيقاف وحفظ",
                pause: "إيقاف مؤقت",
                timer_running: "المؤقت يعمل",
                timer_paused: "المؤقت متوقف",
                current_job: "العمل الحالي",
                duration: "المدة",
                payment: "المبلغ",
                today_summary: "📊 ملخص اليوم",
                total_time: "الوقت الإجمالي",
                total_payment: "المبلغ الإجمالي",
                manual_entry_title: "إدخال الوقت يدوياً",
                manual_entry_desc: "أدخل أوقات البدء والانتهاء لحساب مدة العمل والمبلغ",
                duration_payment: "المدة والمبلغ",
                work_history: "سجل العمل",
                no_history: "لا يوجد سجل عمل بعد",
                at: "في",
                worker_settings: "إعدادات المستخدم",
                your_name: "اسمك",
                name_appears: "سيظهر هذا الاسم في التقارير",
                save_name: "حفظ الاسم",
                submit_sessions: "إرسال جلسات العمل",
                send_unsent: "إرسال جلسات العمل غير المرسلة",
                unsent_sessions: "الجلسات غير المرسلة:",
                total_hours: "إجمالي الساعات:",
                no_sessions: "لا توجد جلسات للإرسال",
                submission_history: "سجل الإرسال",
                no_submissions: "لا توجد إرسالات بعد",
                waiting_approval: "في انتظار مراجعة المشرف",
                approved_by: "تمت المراجعة من المشرف",
                paid: "المدفوع:",
                remaining: "المتبقي:",
                payment_history: "سجل المدفوعات",
                payments: "دفعات",
                sessions: "جلسات",
                session: "جلسة",
                client: "الزبون:",
                total_amount: "المبلغ الإجمالي:",
                already_paid: "المدفوع:",
                payment_amount: "مبلغ الدفعة (درهم):",
                device_registration: "تسجيل الجهاز",
                registration_desc: "أدخل رمز التسجيل للوصول إلى التطبيق. اتصل بالمشرف إذا لم يكن لديك رمز.",
                register_device: "تسجيل هذا الجهاز",
                edit: "تعديل",
                edit_session: "تعديل الجلسة",
                save_changes: "حفظ التعديلات",
                original_price: "السعر الأصلي:",
                adjusted_price: "السعر المعدل:",
                time_format: "صيغة الوقت",
                time_format_24h: "24 ساعة (14:30)",
                time_format_12h: "12 ساعة (2:30 م)",
                adjust_price: "تعديل السعر",
                discount_reason: "سبب الخصم/التعديل:",
                apply_discount: "تطبيق التعديل",
                reset_price: "إعادة تعيين السعر الأصلي",
                morning: "صباحًا",
                evening: "مساءً",
                mark_fully_paid: "تحديد كمدفوع بالكامل",
                client_cannot_pay_more: "(الزبون لا يستطيع دفع المبلغ المتبقي)",
                confirm_full_payment: "الزبون يستطيع دفع {amount} درهم فقط؟",
                remaining_unpayable: "المبلغ المتبقي {amount} درهم سيتم تحديده كغير قابل للدفع.",
                worker_marked_paid: "تم التحديد كمدفوع بالكامل من قبل العامل",
                cannot_pay_remaining: "الزبون لا يستطيع دفع المبلغ المتبقي {amount} درهم",
                clear_unsent_sessions: "مسح الجلسات غير المرسلة",
                clear_submission_history: "مسح سجل الإرساليات",
                confirm_clear_unsent: "حذف جميع جلسات العمل غير المرسلة؟ لا يمكن التراجع عن هذا الإجراء!",
                confirm_clear_submissions: "⚠️ تحذير: حذف كل سجل الإرساليات؟\n\nسيتم حذف نهائيًا:\n• جميع الجلسات المرسلة\n• جميع سجلات الدفع\n• جميع سجلات العمل\n\nلا يمكن التراجع عن هذا الإجراء!\n\nهل أنت متأكد تمامًا؟"
            }
        };

        function t(key) {
            return translations[currentLang][key] || key;
        }

        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'ar' : 'en';
            localStorage.setItem('language', currentLang);
            applyLanguage();
        }

        function applyLanguage() {
            const html = document.documentElement;
            const body = document.body;
            const langToggle = document.getElementById('lang-toggle');
            
            if (currentLang === 'ar') {
                html.setAttribute('dir', 'rtl');
                html.setAttribute('lang', 'ar');
                body.setAttribute('dir', 'rtl');
                if (langToggle) langToggle.textContent = 'EN';
            } else {
                html.setAttribute('dir', 'ltr');
                html.setAttribute('lang', 'en');
                body.setAttribute('dir', 'ltr');
                if (langToggle) langToggle.textContent = 'AR';
            }
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[currentLang][key]) {
                    // For option elements, update text content
                    if (el.tagName === 'OPTION') {
                        el.textContent = translations[currentLang][key];
                    } else {
                        el.textContent = translations[currentLang][key];
                    }
                }
            });
            
            if (typeof renderSavedJobs === 'function') renderSavedJobs();
            if (typeof renderManualSavedJobs === 'function') renderManualSavedJobs();
            if (typeof renderHistory === 'function') renderHistory();
            if (typeof renderSubmissionHistory === 'function') renderSubmissionHistory();
            if (typeof updateTodaySummary === 'function') updateTodaySummary();
            
            console.log('🌐 Language changed to:', currentLang);
        }

        window.addEventListener('DOMContentLoaded', () => {
            applyLanguage();
        });

        // ========================================
        // 📊 MAIN APP CODE
        // ========================================

        let timerInterval = null;
        let startTime = null;
        let elapsedTime = 0;
        let isPaused = false;
        let currentJob = null;
        let reminderInterval = null;

        function loadData() {
            const data = localStorage.getItem('excavatorTimer');
            const parsed = data ? JSON.parse(data) : { jobs: [], history: [] };
            
            // Fix: Mark all old sessions without 'sent' property as unsent
            if (parsed.history && parsed.history.length > 0) {
                parsed.history.forEach(h => {
                    if (h.sent === undefined) {
                        h.sent = false;
                    }
                });
                // Save the fixed data back
                saveData(parsed);
            }
            
            return parsed;
        }

        function saveData(data) {
            localStorage.setItem('excavatorTimer', JSON.stringify(data));
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
        }

        function formatHM(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            return h + 'h ' + m + 'm';
        }

        function calculatePayment(seconds, rate) {
            const payment = (seconds / 3600) * rate;
            return Math.floor(payment).toFixed(2); // Round DOWN to remove decimals
        }

        function updateTimer() {
            if (!isPaused) {
                elapsedTime = Math.floor((Date.now() - startTime) / 1000);
            }
            document.getElementById('timer').textContent = formatTime(elapsedTime);
            document.getElementById('payment').textContent = calculatePayment(elapsedTime, currentJob.rate) + ' MAD';
        }

        function startTimer() {
            const data = loadData();
            const selected = document.querySelector('.saved-job-item.selected');
            
            let jobSite, clientName, rate;
            if (selected) {
                const job = data.jobs[parseInt(selected.dataset.index)];
                jobSite = job.jobSite;
                clientName = job.clientName;
                rate = job.rate;
            } else {
                jobSite = document.getElementById('job-site').value.trim();
                clientName = document.getElementById('client-name').value.trim();
                rate = parseFloat(document.getElementById('hourly-rate').value);
            }

            if (!jobSite || !clientName || !rate || rate <= 0) {
                return;
            }

            if (!selected && !data.jobs.find(j => j.jobSite === jobSite && j.clientName === clientName)) {
                data.jobs.push({ jobSite: jobSite, clientName: clientName, rate: rate });
                saveData(data);
            }

            currentJob = { jobSite: jobSite, clientName: clientName, rate: rate, startTime: new Date().toISOString() };
            document.getElementById('current-job-site').textContent = jobSite;
            document.getElementById('current-client-name').textContent = clientName;
            document.getElementById('current-rate').textContent = rate;
            document.getElementById('setup-section').style.display = 'none';
            document.getElementById('timer-section').style.display = 'block';

            startTime = Date.now();
            elapsedTime = 0;
            isPaused = false;
            timerInterval = setInterval(updateTimer, 1000);
            updateTimer();

            startReminder();
            if (Notification.permission === 'default') Notification.requestPermission();
        }

        function pauseTimer() {
            if (isPaused) {
                startTime = Date.now() - (elapsedTime * 1000);
                isPaused = false;
                document.getElementById('pause-btn').textContent = 'Pause';
                timerInterval = setInterval(updateTimer, 1000);
            } else {
                isPaused = true;
                document.getElementById('pause-btn').textContent = 'Resume';
                clearInterval(timerInterval);
            }
        }

        async function stopTimer() {
            clearInterval(timerInterval);
            clearInterval(reminderInterval);

            const data = loadData();
            const newSession = {
                timestamp: Date.now(),
                jobSite: currentJob.jobSite,
                clientName: currentJob.clientName,
                rate: currentJob.rate,
                startTime: currentJob.startTime,
                endTime: new Date().toISOString(),
                duration: elapsedTime,
                payment: calculatePayment(elapsedTime, currentJob.rate),
                sent: false
            };
            
            data.history.push(newSession);
            saveData(data);
            
            // Auto-save to Firebase
            await window.saveDraftToFirebase(newSession);

            document.getElementById('setup-section').style.display = 'block';
            document.getElementById('timer-section').style.display = 'none';
            document.getElementById('job-site').value = '';
            document.getElementById('client-name').value = '';
            document.getElementById('hourly-rate').value = '';
            const sel = document.querySelector('.saved-job-item.selected');
            if (sel) sel.classList.remove('selected');

            currentJob = null;
            elapsedTime = 0;
            updateTodaySummary();
            renderSavedJobs();
        }

        function startReminder() {
            reminderInterval = setInterval(() => {
                if (!isPaused && Notification.permission === 'granted') {
                    new Notification('⏰ Work Timer Reminder', {
                        body: 'You have been working for ' + formatHM(elapsedTime) + '. Remember to take breaks!'
                    });
                }
            }, 60 * 60 * 1000);
        }

        function updateTodaySummary() {
            const data = loadData();
            const today = new Date().toDateString();
            const todaySessions = data.history.filter(h => new Date(h.endTime).toDateString() === today);
            const totalSeconds = todaySessions.reduce((sum, h) => sum + h.duration, 0);
            const totalPayment = todaySessions.reduce((sum, h) => sum + parseFloat(h.payment), 0);
            document.getElementById('today-hours').textContent = formatHM(totalSeconds);
            document.getElementById('today-payment').textContent = totalPayment.toFixed(2) + ' MAD';
        }

        function renderSavedJobs() {
            const data = loadData();
            const container = document.getElementById('saved-jobs-list');
            if (data.jobs.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 20px;">' + t('no_saved_jobs') + '</p>';
                return;
            }
            container.innerHTML = data.jobs.map((job, i) => 
                '<div class="saved-job-item" data-index="' + i + '" onclick="selectJob(' + i + ')">' +
                '<div>' +
                '<div style="font-size: 13px; color: #64748b;">📍 ' + (job.jobSite || job.name || 'Unknown') + '</div>' +
                '<div style="font-weight: 600; margin: 3px 0;">👤 ' + (job.clientName || job.name || 'Unknown') + '</div>' +
                '<div style="font-size: 14px; color: #64748b;">💰 ' + job.rate + ' MAD/hour</div></div></div>'
            ).join('');
        }

        function selectJob(index) {
            document.querySelectorAll('.saved-job-item').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.saved-job-item')[index].classList.add('selected');
            document.getElementById('job-site').value = '';
            document.getElementById('client-name').value = '';
            document.getElementById('hourly-rate').value = '';
        }

        function renderHistory() {
            const data = loadData();
            const container = document.getElementById('history-list');
            if (data.history.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 40px;">No history yet</p>';
                return;
            }
            const sorted = [...data.history].sort((a, b) => new Date(b.endTime) - new Date(a.endTime));
            container.innerHTML = sorted.map((h, originalIndex) => {
                // Find original index in unsorted array
                const actualIndex = data.history.findIndex(item => 
                    item.endTime === h.endTime && item.duration === h.duration
                );
                const date = new Date(h.endTime);
                const jobSite = h.jobSite || h.job || 'Unknown';
                const clientName = h.clientName || h.job || 'Unknown';
                
                // Check if session is unsent (can be edited)
                const isUnsent = h.sent === false || h.sent === undefined;
                const editBtn = isUnsent 
                    ? '<button class="delete-history-btn" onclick="editHistory(' + actualIndex + ')" style="right: 70px; background: #dbeafe; color: #2563eb;">✏️ ' + t('edit') + '</button>' 
                    : '';
                
                const timeDisplay = formatTimeDisplay(h.startTime) + ' - ' + formatTimeDisplay(h.endTime);
                
                return '<div class="history-item">' +
                    '<button class="delete-history-btn" onclick="deleteHistory(' + actualIndex + ')">' + t('delete') + '</button>' +
                    editBtn +
                    '<div style="font-size: 12px; color: #64748b; margin-bottom: 5px;">' + 
                    date.toLocaleDateString() + '</div>' +
                    '<div style="font-size: 11px; color: #64748b; margin-bottom: 5px;">🕐 ' + timeDisplay + '</div>' +
                    '<div style="font-size: 13px; color: #64748b; margin-bottom: 3px;">📍 ' + jobSite + '</div>' +
                    '<div style="font-weight: 600; margin-bottom: 8px;">👤 ' + clientName + '</div>' +
                    '<div style="display: flex; justify-content: space-between; font-size: 14px; padding-right: 80px;">' +
                    '<span>' + formatHM(h.duration) + ' @ ' + h.rate + ' MAD/hr</span>' +
                    '<span style="color: #2563eb; font-weight: 600; font-size: 16px;">' + h.payment + ' MAD</span></div></div>';
            }).join('');
        }

        function deleteHistory(index) {
            const data = loadData();
            data.history.splice(index, 1);
            saveData(data);
            
            renderHistory();
            updateTodaySummary();
        }

        // Clear only unsent sessions
        async function clearUnsentSessions() {
            const data = loadData();
            const unsentCount = data.history.filter(h => h.sent === false || h.sent === undefined).length;
            
            if (unsentCount === 0) {
                await customAlert('No unsent sessions to clear!', 'ℹ️');
                return;
            }
            
            const confirmed = await customConfirm(t('confirm_clear_unsent'), '⚠️');
            if (!confirmed) return;
            
            // Delete unsent sessions from Firebase
            const unsentSessions = data.history.filter(h => h.sent === false || h.sent === undefined);
            for (const session of unsentSessions) {
                if (session.timestamp) {
                    await window.deleteDraftFromFirebase(session.timestamp);
                }
            }
            
            // Remove unsent sessions from local data
            data.history = data.history.filter(h => h.sent === true);
            saveData(data);
            
            renderHistory();
            updateTodaySummary();
            updateSubmitSummary();
            
            await customAlert(`✅ Cleared ${unsentCount} unsent session(s)!`, '✅');
        }

        // Clear all submission history
        async function clearSubmissionHistory() {
            const data = loadData();
            const submissionCount = data.submissions ? data.submissions.length : 0;
            
            if (submissionCount === 0) {
                await customAlert('No submission history to clear!', 'ℹ️');
                return;
            }
            
            const confirmed = await customConfirm(t('confirm_clear_submissions'), '⚠️');
            if (!confirmed) return;
            
            // Clear all submissions
            data.submissions = [];
            saveData(data);
            
            renderSubmissionHistory();
            
            await customAlert(`✅ Cleared ${submissionCount} submission(s)!`, '✅');
        }

        // ========================================
        // 🎨 CUSTOM MODAL SYSTEM (No URL shown!)
        // ========================================
        
        // Custom Alert - replaces native alert()
        function customAlert(message, icon = 'ℹ️') {
            return new Promise((resolve) => {
                const modal = document.getElementById('customAlertModal');
                const messageDiv = document.getElementById('customAlertMessage');
                const iconDiv = document.getElementById('customAlertIcon');
                const okBtn = document.getElementById('customAlertOkBtn');
                
                messageDiv.textContent = message;
                iconDiv.textContent = icon;
                modal.style.display = 'flex';
                
                const handleOk = () => {
                    modal.style.display = 'none';
                    okBtn.removeEventListener('click', handleOk);
                    resolve(true);
                };
                
                okBtn.addEventListener('click', handleOk);
            });
        }
        
        // Custom Confirm - replaces native confirm()
        function customConfirm(message, icon = '⚠️') {
            return new Promise((resolve) => {
                const modal = document.getElementById('customConfirmModal');
                const messageDiv = document.getElementById('customConfirmMessage');
                const iconDiv = document.getElementById('customConfirmIcon');
                const okBtn = document.getElementById('customConfirmOkBtn');
                const cancelBtn = document.getElementById('customConfirmCancelBtn');
                
                messageDiv.textContent = message;
                iconDiv.textContent = icon;
                modal.style.display = 'flex';
                
                const handleOk = () => {
                    modal.style.display = 'none';
                    okBtn.removeEventListener('click', handleOk);
                    cancelBtn.removeEventListener('click', handleCancel);
                    resolve(true);
                };
                
                const handleCancel = () => {
                    modal.style.display = 'none';
                    okBtn.removeEventListener('click', handleOk);
                    cancelBtn.removeEventListener('click', handleCancel);
                    resolve(false);
                };
                
                okBtn.addEventListener('click', handleOk);
                cancelBtn.addEventListener('click', handleCancel);
            });
        }
        
        // Custom Prompt - replaces native prompt()
        function customPrompt(message, icon = '✏️') {
            return new Promise((resolve) => {
                // Create prompt modal dynamically
                const modal = document.createElement('div');
                modal.style.cssText = 'display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;';
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 20px; padding: 30px; max-width: 400px; width: 90%; margin: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="text-align: center; font-size: 48px; margin-bottom: 15px;">${icon}</div>
                        <div style="font-size: 16px; color: #1e293b; text-align: center; margin-bottom: 20px; line-height: 1.6;">${message}</div>
                        <input type="text" id="customPromptInput" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; margin-bottom: 20px; box-sizing: border-box;" placeholder="Enter your name" autofocus>
                        <div style="display: flex; gap: 10px;">
                            <button id="customPromptCancelBtn" style="flex: 1; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: white; color: #64748b;">Cancel</button>
                            <button id="customPromptOkBtn" style="flex: 1; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); color: white;">OK</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                const inputField = document.getElementById('customPromptInput');
                const okBtn = document.getElementById('customPromptOkBtn');
                const cancelBtn = document.getElementById('customPromptCancelBtn');
                
                // Focus on input
                setTimeout(() => inputField.focus(), 100);
                
                const handleOk = () => {
                    const value = inputField.value.trim();
                    document.body.removeChild(modal);
                    resolve(value);
                };
                
                const handleCancel = () => {
                    document.body.removeChild(modal);
                    resolve(null);
                };
                
                const handleEnter = (e) => {
                    if (e.key === 'Enter') {
                        handleOk();
                    } else if (e.key === 'Escape') {
                        handleCancel();
                    }
                };
                
                okBtn.addEventListener('click', handleOk);
                cancelBtn.addEventListener('click', handleCancel);
                inputField.addEventListener('keydown', handleEnter);
            });
        }

        async function clearAllHistory() {
            const firstConfirm = await customConfirm('⚠️ Are you sure you want to delete ALL history?\n\nThis will:\n- Delete all work sessions\n- Delete all submissions\n- Clear all saved jobs\n\nThis action CANNOT be undone!', '⚠️');
            if (!firstConfirm) {
                return;
            }

            // Second confirmation for safety
            const secondConfirm = await customConfirm('Final confirmation: Delete EVERYTHING?', '🚨');
            if (!secondConfirm) {
                return;
            }

            // Clear all data
            const data = {
                jobs: [],
                history: [],
                submissions: [],
                workerName: loadData().workerName // Keep worker name
            };
            saveData(data);

            // Update UI
            renderHistory();
            updateTodaySummary();
            renderSavedJobs();
            
            await customAlert('✅ All history cleared!', '✅');
            
            // Refresh the page to reset everything
            location.reload();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + '-view').classList.add('active');
            if (tab === 'history') renderHistory();
            if (tab === 'manual') renderManualSavedJobs();
            if (tab === 'settings') loadSettings();
        }

        function loadSettings() {
            const data = loadData();
            const workerName = data.workerName || '';
            document.getElementById('worker-name').value = workerName;
            updateSubmitSummary();
            renderSubmissionHistory();
            initializeTimeFormat();
        }

        function saveWorkerName() {
            const name = document.getElementById('worker-name').value.trim();
            if (!name) return;
            
            const data = loadData();
            data.workerName = name;
            saveData(data);
        }

        function updateSubmitSummary() {
            const data = loadData();
            const today = new Date().toDateString();
            
            // Mark all sessions as not sent initially if property doesn't exist
            data.history.forEach(h => {
                if (h.sent === undefined) h.sent = false;
            });
            
            // Get unsent sessions from today
            const unsentSessions = data.history.filter(h => 
                new Date(h.endTime).toDateString() === today && h.sent === false
            );
            
            const submitBtn = document.querySelector('[onclick="submitToAdmin()"]');
            
            if (unsentSessions.length === 0) {
                document.getElementById('submit-summary').innerHTML = 
                    '<p style="color: #94a3b8; text-align: center;">' + t('no_sessions') + '</p>';
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.style.opacity = '0.5';
                    submitBtn.style.cursor = 'not-allowed';
                    submitBtn.textContent = t('no_sessions').toUpperCase();
                }
                return;
            }

            // Calculate total payment (considering adjusted prices)
            const totalSeconds = unsentSessions.reduce((sum, h) => sum + h.duration, 0);
            const totalPayment = unsentSessions.reduce((sum, h) => {
                const price = h.adjustedPrice !== undefined ? parseFloat(h.adjustedPrice) : parseFloat(h.payment);
                return sum + price;
            }, 0);

            // Build session list with adjust price buttons
            let sessionListHTML = '';
            unsentSessions.forEach((session, index) => {
                const actualIndex = data.history.findIndex(h => 
                    h.endTime === session.endTime && h.duration === session.duration
                );
                const clientName = session.clientName || session.job || 'Unknown';
                const jobSite = session.jobSite || session.job || 'Unknown';
                const originalPrice = parseFloat(session.payment);
                const currentPrice = session.adjustedPrice !== undefined ? parseFloat(session.adjustedPrice) : originalPrice;
                const isPriceAdjusted = session.adjustedPrice !== undefined && session.adjustedPrice !== session.payment;
                
                sessionListHTML += 
                    '<div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid ' + (isPriceAdjusted ? '#f59e0b' : '#2563eb') + ';">' +
                    '<div style="font-size: 12px; color: #64748b; margin-bottom: 3px;">📍 ' + jobSite + '</div>' +
                    '<div style="font-weight: 600; font-size: 14px; margin-bottom: 5px;">👤 ' + clientName + '</div>' +
                    '<div style="display: flex; justify-content: space-between; align-items: center;">' +
                    '<div style="font-size: 13px; color: #64748b;">' + formatHM(session.duration) + '</div>' +
                    '<div style="text-align: right;">' +
                    (isPriceAdjusted ? 
                        '<div style="font-size: 11px; color: #94a3b8; text-decoration: line-through;">' + originalPrice.toFixed(2) + ' MAD</div>' +
                        '<div style="font-size: 16px; font-weight: 600; color: #f59e0b;">⚡ ' + currentPrice.toFixed(2) + ' MAD</div>' 
                        : 
                        '<div style="font-size: 16px; font-weight: 600; color: #2563eb;">' + currentPrice.toFixed(2) + ' MAD</div>'
                    ) +
                    '</div></div>' +
                    '<button onclick="showPriceAdjustModal(' + actualIndex + ')" style="width: 100%; margin-top: 8px; padding: 8px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 12px; font-weight: 600; color: #64748b; cursor: pointer;">💰 ' + t('adjust_price') + '</button>' +
                    '</div>';
            });

            document.getElementById('submit-summary').innerHTML = sessionListHTML +
                '<div style="margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 8px; border: 2px solid #0ea5e9;">' +
                '<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">' +
                '<span style="color: #0c4a6e; font-weight: 600;">' + t('total_hours') + '</span>' +
                '<strong style="color: #0c4a6e;">' + formatHM(totalSeconds) + '</strong></div>' +
                '<div style="display: flex; justify-content: space-between;">' +
                '<span style="color: #0c4a6e; font-weight: 600;">' + t('total_payment') + '</span>' +
                '<strong style="color: #0369a1; font-size: 18px;">' + totalPayment.toFixed(2) + ' MAD</strong></div></div>';
            
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.style.opacity = '1';
                submitBtn.style.cursor = 'pointer';
                submitBtn.textContent = t('submit_admin').toUpperCase();
            }
        }

        async function submitToAdmin() {
            console.log('=== SUBMIT BUTTON CLICKED ===');
            const data = loadData();
            console.log('Loaded data:', data);
            const workerName = data.workerName || 'Unknown Worker';
            
            if (!data.workerName) {
                console.log('ERROR: No worker name set!');
                await customAlert('Please save your name first!', '⚠️');
                return;
            }

            const today = new Date().toDateString();
            console.log('Today:', today);
            
            // Get only unsent sessions from today
            const unsentSessions = data.history.filter(h => 
                new Date(h.endTime).toDateString() === today && h.sent === false
            );

            console.log('Unsent sessions found:', unsentSessions);

            if (unsentSessions.length === 0) {
                console.log('ERROR: No unsent sessions to submit');
                await customAlert('No unsent sessions to submit!', 'ℹ️');
                return;
            }

            // ✨ NEW: Group sessions by CLIENT NAME
            const groupedByClient = {};
            unsentSessions.forEach(session => {
                const clientName = session.clientName || session.job || 'Unknown';
                if (!groupedByClient[clientName]) {
                    groupedByClient[clientName] = [];
                }
                groupedByClient[clientName].push(session);
            });

            console.log('📊 Grouped by client:', groupedByClient);
            console.log('📊 Number of clients:', Object.keys(groupedByClient).length);

            // Create SEPARATE submission for EACH client
            const submissionsCreated = [];
            
            for (const [clientName, clientSessions] of Object.entries(groupedByClient)) {
                const totalSeconds = clientSessions.reduce((sum, h) => sum + h.duration, 0);
                // Use adjusted price if available, otherwise use original payment
                const totalPayment = clientSessions.reduce((sum, h) => {
                    const price = h.adjustedPrice !== undefined ? parseFloat(h.adjustedPrice) : parseFloat(h.payment);
                    return sum + price;
                }, 0);

            const submission = {
                workerName: workerName,
                    clientName: clientName,
                date: new Date().toISOString(),
                    sessions: clientSessions,
                totalHours: formatHM(totalSeconds),
                    totalPayment: Math.floor(totalPayment).toFixed(2),
                    timestamp: Date.now() + submissionsCreated.length, // Unique timestamp
                    status: 'pending',
                    paymentStatus: 'unpaid',
                    totalPaid: 0,
                    payments: []
                };

                submissionsCreated.push(submission);
                console.log('✅ Created submission for client:', clientName, submission);
            }

            // Mark ALL sessions as sent
            data.history.forEach(h => {
                const isInUnsent = unsentSessions.find(us => 
                    us.endTime === h.endTime && us.duration === h.duration
                );
                if (isInUnsent) {
                    h.sent = true;
                }
            });

            // Send EACH submission to Firebase FIRST, then save locally with Firebase keys
            if (!data.submissions) data.submissions = [];
            
            try {
                for (const submission of submissionsCreated) {
                    const submissionsRef = window.firebaseRef(window.firebaseDB, 'submissions');
                    const newSubmissionRef = window.firebasePush(submissionsRef);
                    const firebaseKey = newSubmissionRef.key;
                    
                    await window.firebaseSet(newSubmissionRef, submission);
                    
                    // Add Firebase key to submission BEFORE saving locally
                    submission.firebaseKey = firebaseKey;
                    
                    console.log('✅ Sent to Firebase with key:', firebaseKey, 'Client:', submission.clientName);
                    console.log('   Timestamp:', submission.timestamp);
                }
                
                // NOW save all submissions locally (with Firebase keys included)
                submissionsCreated.forEach(sub => data.submissions.push(sub));
                saveData(data);
                
                console.log('🎉 All', submissionsCreated.length, 'submissions sent successfully!');
                console.log('📝 Saved submissions with Firebase keys:', data.submissions.map(s => ({ 
                    timestamp: s.timestamp, 
                    firebaseKey: s.firebaseKey, 
                    client: s.clientName 
                })));
                
                // Delete drafts from Firebase after successful submission
                console.log('🗑️ Deleting submitted drafts from Firebase...');
                for (const session of unsentSessions) {
                    if (session.timestamp) {
                        await window.deleteDraftFromFirebase(session.timestamp);
                    }
                }
                console.log('✅ Drafts cleaned up from Firebase');
                
            } catch (error) {
                console.error('❌ Firebase error:', error);
                await customAlert('Note: Saved locally but could not sync to admin. Check internet connection.', '⚠️');
            }

            // Force refresh
            setTimeout(() => {
            renderSubmissionHistory();
            updateSubmitSummary();
            }, 100);
        }

        function renderSubmissionHistory() {
            const data = loadData();
            const submissions = data.submissions || [];
            const container = document.getElementById('submission-list');

            console.log('Rendering submissions:', submissions); // Debug

            if (submissions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 20px;">' + t('no_submissions') + '</p>';
                return;
            }

            const sorted = [...submissions].sort((a, b) => b.timestamp - a.timestamp);
            container.innerHTML = sorted.slice(0, 10).map((s, index) => {
                const date = new Date(s.date);
                const status = s.status || 'pending';
                const statusColor = status === 'approved' ? '#22c55e' : '#f59e0b';
                const statusText = status === 'approved' ? '✅ ' + t('approved').toUpperCase() : '⏳ ' + t('pending').toUpperCase();
                const statusMessage = status === 'approved' ? t('approved_by') : t('waiting_approval');
                
                // Payment status
                const paymentStatus = s.paymentStatus || 'unpaid';
                const totalPaid = parseFloat(s.totalPaid || 0);
                const totalAmount = parseFloat(s.totalPayment);
                const remaining = totalAmount - totalPaid;
                const percentage = totalAmount > 0 ? Math.round((totalPaid / totalAmount) * 100) : 0;
                
                let paymentColor, paymentIcon, paymentText;
                if (paymentStatus === 'fully_paid') {
                    // Check if this is a "marked as fully paid" case (partial payment closed)
                    if (s.fullyPaidNote) {
                        paymentColor = '#f59e0b';
                        paymentIcon = '🟠';
                        paymentText = 'PAYMENT CLOSED';
                    } else {
                        paymentColor = '#22c55e';
                        paymentIcon = '✅';
                        paymentText = t('fully_paid').toUpperCase();
                    }
                } else if (paymentStatus === 'partially_paid') {
                    paymentColor = '#f59e0b';
                    paymentIcon = '🟡';
                    paymentText = t('partially_paid').toUpperCase();
                } else {
                    paymentColor = '#ef4444';
                    paymentIcon = '🔴';
                    paymentText = t('unpaid').toUpperCase();
                }
                
                const paymentsHistory = (s.payments || []).map(p => {
                    const pDate = new Date(p.date);
                    return '<div style="font-size: 11px; color: #64748b; padding: 3px 0;">✅ ' + 
                           p.amount.toFixed(2) + ' MAD - ' + 
                           pDate.toLocaleDateString() + ' ' + pDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) + 
                           '</div>';
                }).join('');
                
                const addPaymentBtn = paymentStatus !== 'fully_paid' 
                    ? '<button onclick="showAddPaymentModal(' + s.timestamp + ')" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; margin-top: 8px;">💰 ' + t('add_payment') + '</button>'
                    : '';
                
                const clientName = s.clientName || (s.sessions && s.sessions[0] ? (s.sessions[0].clientName || s.sessions[0].job) : 'Unknown');
                const jobSites = s.sessions ? [...new Set(s.sessions.map(sess => sess.jobSite || sess.job || 'Unknown'))].join(', ') : 'Unknown';
                
                // Format the total payment display based on payment status
                let totalPaymentDisplay;
                if (s.fullyPaidNote) {
                    // Payment closed - show crossed out original + actual amount
                    totalPaymentDisplay = '<div style="text-align: right;">' +
                        '<div style="text-decoration: line-through; color: #94a3b8; font-size: 12px;">' + s.totalPayment + ' MAD</div>' +
                        '<strong style="color: #f59e0b; font-size: 16px;">' + totalPaid.toFixed(2) + ' MAD</strong>' +
                        '</div>';
                } else {
                    // Normal display
                    totalPaymentDisplay = '<strong style="color: #2563eb;">' + s.totalPayment + ' MAD</strong>';
                }
                
                return '<div style="background: #f8fafc; padding: 12px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid ' + statusColor + ';">' +
                    '<div style="font-size: 12px; color: #64748b; margin-bottom: 5px;">' + 
                    date.toLocaleDateString() + ' at ' + date.toLocaleTimeString() + '</div>' +
                    
                    '<div style="font-size: 13px; color: #64748b; margin-bottom: 3px;">📍 ' + jobSites + '</div>' +
                    '<div style="font-weight: 600; font-size: 16px; color: #2563eb; margin-bottom: 8px;">👤 ' + clientName + '</div>' +
                    
                    '<div style="display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 8px;">' +
                    '<span>' + s.sessions.length + ' ' + (s.sessions.length === 1 ? t('session') : t('sessions')) + ' · ' + s.totalHours + '</span>' +
                    totalPaymentDisplay + '</div>' +
                    
                    '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">' +
                    '<span style="font-size: 12px; font-weight: 600; color: ' + statusColor + ';">' + statusText + '</span>' +
                    '<span style="font-size: 11px; color: #64748b;">' + statusMessage + '</span></div>' +
                    
                    '<div style="background: white; padding: 10px; border-radius: 6px; margin-top: 8px;">' +
                    '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">' +
                    '<span style="font-size: 12px; font-weight: 600; color: ' + paymentColor + ';">' + paymentIcon + ' ' + paymentText + '</span>' +
                    '<span style="font-size: 11px; color: #64748b;">' + percentage + '%</span></div>' +
                    
                    (paymentStatus !== 'fully_paid' ? 
                        '<div style="font-size: 12px; color: #64748b; margin-top: 5px;">' +
                        t('paid') + ' <strong>' + totalPaid.toFixed(2) + ' MAD</strong> / ' + totalAmount.toFixed(2) + ' MAD<br>' +
                        t('remaining') + ' <strong style="color: #ef4444;">' + remaining.toFixed(2) + ' MAD</strong></div>' 
                        : 
                        // Check if this is a "marked as fully paid" case (show actual paid amount)
                        (s.fullyPaidNote ? 
                            '<div style="font-size: 12px; color: #f59e0b; margin-top: 5px;">' +
                            '<span style="text-decoration: line-through; color: #94a3b8;">' + totalAmount.toFixed(2) + ' MAD</span><br>' +
                            '<strong style="font-size: 16px; color: #f59e0b;">' + totalPaid.toFixed(2) + ' MAD</strong> ' +
                            '<span style="font-size: 11px; color: #64748b;">(actual amount received)</span>' +
                            '</div>' +
                            '<div style="font-size: 11px; color: #f59e0b; margin-top: 5px; padding: 5px; background: #fef3c7; border-radius: 4px;">ℹ️ ' + s.fullyPaidNote + '</div>'
                            :
                            '<div style="font-size: 12px; color: #22c55e; margin-top: 5px;">✅ ' + t('fully_paid') + ': ' + totalAmount.toFixed(2) + ' MAD</div>'
                        )
                    ) +
                    
                    (paymentsHistory ? 
                        '<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e2e8f0;">' +
                        '<div style="font-size: 11px; font-weight: 600; color: #64748b; margin-bottom: 3px;">' + t('payment_history') + ':</div>' +
                        paymentsHistory + '</div>' 
                        : '') +
                    
                    addPaymentBtn +
                    '</div></div>';
            }).join('');
        }

        let manualCalculation = null;

        function renderManualSavedJobs() {
            const data = loadData();
            const container = document.getElementById('manual-saved-jobs');
            if (data.jobs.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 20px;">' + t('no_saved_jobs') + '</p>';
                return;
            }
            container.innerHTML = data.jobs.map((job, i) => 
                '<div class="saved-job-item" data-index="' + i + '" onclick="selectManualJob(' + i + ')">' +
                '<div>' +
                '<div style="font-size: 13px; color: #64748b;">📍 ' + (job.jobSite || job.name || 'Unknown') + '</div>' +
                '<div style="font-weight: 600; margin: 3px 0;">👤 ' + (job.clientName || job.name || 'Unknown') + '</div>' +
                '<div style="font-size: 14px; color: #64748b;">💰 ' + job.rate + ' MAD/hour</div></div>' +
                '<button class="delete-btn" onclick="event.stopPropagation(); deleteJobFromManual(' + i + ')">' + t('delete') + '</button></div>'
            ).join('');
        }

        function deleteJobFromManual(index) {
            const data = loadData();
            data.jobs.splice(index, 1);
            saveData(data);
            
            renderManualSavedJobs();
            renderSavedJobs();
        }

        function selectManualJob(index) {
            const data = loadData();
            const job = data.jobs[index];
            document.getElementById('manual-job-site').value = job.jobSite || job.name || '';
            document.getElementById('manual-client-name').value = job.clientName || job.name || '';
            document.getElementById('manual-hourly-rate').value = job.rate;
            document.querySelectorAll('#manual-saved-jobs .saved-job-item').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('#manual-saved-jobs .saved-job-item')[index].classList.add('selected');
        }

        function calculateManual() {
            const jobSite = document.getElementById('manual-job-site').value.trim();
            const clientName = document.getElementById('manual-client-name').value.trim();
            const rate = parseFloat(document.getElementById('manual-hourly-rate').value);
            let startTime = document.getElementById('manual-start-time').value.trim();
            let stopTime = document.getElementById('manual-stop-time').value.trim();

            if (!jobSite || !clientName || !rate || !startTime || !stopTime) {
                return;
            }

            // If 12-hour format, convert based on AM/PM selection
            if (timeFormat === '12h') {
                const startPeriod = document.getElementById('manual-start-period').value;
                const stopPeriod = document.getElementById('manual-stop-period').value;
                
                startTime = convertTo24Hour(startTime, startPeriod);
                stopTime = convertTo24Hour(stopTime, stopPeriod);
            }

            // Validate time format (HH:MM)
            const timeRegex = /^([0-1][0-9]|2[0-3]):([0-5][0-9])$/;
            if (!timeRegex.test(startTime) || !timeRegex.test(stopTime)) {
                return;
            }

            // Get today's date
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const dateString = year + '-' + month + '-' + day;

            // Combine date with time
            const start = new Date(dateString + 'T' + startTime);
            let stop = new Date(dateString + 'T' + stopTime);

            // If stop time is before start time, assume it's next day
            if (stop <= start) {
                stop.setDate(stop.getDate() + 1);
            }

            const durationSeconds = Math.floor((stop - start) / 1000);
            const payment = calculatePayment(durationSeconds, rate);

            manualCalculation = {
                jobSite: jobSite,
                clientName: clientName,
                rate: rate,
                startTime: start.toISOString(),
                endTime: stop.toISOString(),
                duration: durationSeconds,
                payment: payment
            };

            document.getElementById('manual-duration').textContent = formatHM(durationSeconds);
            document.getElementById('manual-payment').textContent = payment + ' MAD';
            document.getElementById('manual-result').style.display = 'block';

            // Save job if it's new
            const data = loadData();
            if (!data.jobs.find(j => j.jobSite === jobSite && j.clientName === clientName)) {
                data.jobs.push({ jobSite: jobSite, clientName: clientName, rate: rate });
                saveData(data);
                renderManualSavedJobs();
            }
        }

        // Convert 12-hour time + AM/PM to 24-hour format
        function convertTo24Hour(time, period) {
            const [hours, minutes] = time.split(':').map(Number);
            let hour24 = hours;
            
            if (period === 'PM' && hours < 12) {
                hour24 = hours + 12;
            } else if (period === 'AM' && hours === 12) {
                hour24 = 0;
            }
            
            return String(hour24).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
        }

        async function saveManual() {
            if (!manualCalculation) {
                return;
            }

            const data = loadData();
            manualCalculation.sent = false; // Mark as not sent yet
            if (!manualCalculation.timestamp) {
                manualCalculation.timestamp = Date.now(); // Add timestamp if missing
            }
            data.history.push(manualCalculation);
            saveData(data);

            // Auto-save to Firebase
            await window.saveDraftToFirebase(manualCalculation);

            // Show success message
            const originalHTML = document.getElementById('manual-result').innerHTML;
            document.getElementById('manual-result').style.display = 'none';
            document.getElementById('manual-result').innerHTML = 
                '<div style="text-align: center; padding: 20px; background: #d1fae5; border-radius: 10px; color: #065f46; font-weight: 600;">' +
                '✅ Work session saved to history!</div>';
            document.getElementById('manual-result').style.display = 'block';
            setTimeout(function() {
                document.getElementById('manual-result').style.display = 'none';
                // Restore original HTML structure
                document.getElementById('manual-result').innerHTML = 
                    '<div style="text-align: center;">' +
                    '<div style="font-size: 14px; color: #166534; margin-bottom: 10px;">Duration & Payment</div>' +
                    '<div style="font-size: 32px; font-weight: bold; color: #15803d;" id="manual-duration">0h 0m</div>' +
                    '<div style="font-size: 36px; font-weight: bold; color: #15803d; margin-top: 10px;" id="manual-payment">0.00 MAD</div>' +
                    '</div>';
            }, 3000);

            // Reset form
            document.getElementById('manual-job-site').value = '';
            document.getElementById('manual-client-name').value = '';
            document.getElementById('manual-hourly-rate').value = '';
            document.getElementById('manual-start-time').value = '';
            document.getElementById('manual-stop-time').value = '';
            document.getElementById('manual-result').style.display = 'none';
            document.querySelectorAll('#manual-saved-jobs .saved-job-item').forEach(el => el.classList.remove('selected'));
            manualCalculation = null;

            updateTodaySummary();
            renderManualSavedJobs();
        }

        // Auto-format time input (add colon automatically)
        function formatTimeInput(input) {
            let value = input.value.replace(/[^0-9]/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + ':' + value.substring(2, 4);
            }
            input.value = value;
        }

        document.getElementById('manual-start-time').addEventListener('input', function() {
            formatTimeInput(this);
        });

        document.getElementById('manual-stop-time').addEventListener('input', function() {
            formatTimeInput(this);
        });

        // Listen to AM/PM changes in manual entry for auto-calculation
        document.getElementById('manual-start-period').addEventListener('change', function() {
            // Trigger calculation if all fields are filled
            const jobSite = document.getElementById('manual-job-site').value.trim();
            const clientName = document.getElementById('manual-client-name').value.trim();
            const rate = document.getElementById('manual-hourly-rate').value.trim();
            const startTime = document.getElementById('manual-start-time').value.trim();
            const stopTime = document.getElementById('manual-stop-time').value.trim();
            
            if (jobSite && clientName && rate && startTime && stopTime) {
                calculateManual();
            }
        });

        document.getElementById('manual-stop-period').addEventListener('change', function() {
            // Trigger calculation if all fields are filled
            const jobSite = document.getElementById('manual-job-site').value.trim();
            const clientName = document.getElementById('manual-client-name').value.trim();
            const rate = document.getElementById('manual-hourly-rate').value.trim();
            const startTime = document.getElementById('manual-start-time').value.trim();
            const stopTime = document.getElementById('manual-stop-time').value.trim();
            
            if (jobSite && clientName && rate && startTime && stopTime) {
                calculateManual();
            }
        });

        updateTodaySummary();
        renderSavedJobs();
        
        // Payment modal functions
        let currentPaymentSubmissionTimestamp = null;

        async function showAddPaymentModal(timestamp) {
            currentPaymentSubmissionTimestamp = timestamp;
            const data = loadData();
            const submission = data.submissions.find(s => s.timestamp === timestamp);
            
            if (!submission) {
                await customAlert('Error: Submission not found!', '❌');
                return;
            }
            
            const totalAmount = parseFloat(submission.totalPayment);
            const totalPaid = parseFloat(submission.totalPaid || 0);
            const remaining = totalAmount - totalPaid;
            
            console.log('💰 Opening payment modal for submission:', {
                timestamp: timestamp,
                totalAmount: totalAmount,
                totalPaid: totalPaid,
                remaining: remaining
            });
            
            document.getElementById('paymentModalInfo').innerHTML = 
                '<strong>' + t('total_amount') + '</strong> ' + totalAmount.toFixed(2) + ' MAD<br>' +
                '<strong>' + t('already_paid') + '</strong> ' + totalPaid.toFixed(2) + ' MAD<br>' +
                '<strong>' + t('remaining') + '</strong> <span style="color: #ef4444; font-weight: 600;">' + remaining.toFixed(2) + ' MAD</span>';
            
            const paymentInput = document.getElementById('paymentAmount');
            paymentInput.value = '';
            paymentInput.max = remaining.toFixed(2);
            paymentInput.placeholder = currentLang === 'ar' ? 'أدخل المبلغ المستلم' : 'Enter amount received';
            paymentInput.disabled = false; // Re-enable input
            
            // Show/hide "Mark as fully paid" checkbox based on remaining amount
            const markFullyPaidSection = document.getElementById('markFullyPaidSection');
            const markFullyPaidCheckbox = document.getElementById('markFullyPaidCheckbox');
            markFullyPaidCheckbox.checked = false; // Reset checkbox
            
            // Only show checkbox if there's remaining amount
            if (remaining > 0) {
                markFullyPaidSection.style.display = 'block';
            } else {
                markFullyPaidSection.style.display = 'none';
            }
            
            // Add event listener to checkbox to disable/enable input
            markFullyPaidCheckbox.onchange = function() {
                if (this.checked) {
                    paymentInput.value = '0';
                    paymentInput.disabled = true;
                    paymentInput.style.opacity = '0.5';
                    paymentInput.style.cursor = 'not-allowed';
                } else {
                    paymentInput.value = '';
                    paymentInput.disabled = false;
                    paymentInput.style.opacity = '1';
                    paymentInput.style.cursor = 'text';
                }
            };
            
            document.getElementById('paymentModal').style.display = 'flex';
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').style.display = 'none';
            currentPaymentSubmissionTimestamp = null;
        }

        async function addPayment() {
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const markFullyPaid = document.getElementById('markFullyPaidCheckbox').checked;
            
            // If marking as fully paid, allow any amount (including 0)
            // Otherwise, require a valid amount
            if (!markFullyPaid && (!amount || amount <= 0)) {
                await customAlert('Please enter a valid payment amount', '⚠️');
                return;
            }
            
            // If no amount entered but marking as fully paid, set amount to 0
            const finalAmount = amount || 0;
            
            const data = loadData();
            const submissionIndex = data.submissions.findIndex(s => s.timestamp === currentPaymentSubmissionTimestamp);
            
            if (submissionIndex === -1) {
                await customAlert('Error: Submission not found!', '❌');
                return;
            }
            
            const submission = data.submissions[submissionIndex];
            
            const totalAmount = parseFloat(submission.totalPayment);
            const totalPaid = parseFloat(submission.totalPaid || 0);
            const remaining = totalAmount - totalPaid;
            
            // Only check if amount exceeds remaining if NOT marking as fully paid
            if (!markFullyPaid && finalAmount > remaining) {
                await customAlert('Payment amount (' + finalAmount.toFixed(2) + ' MAD) exceeds remaining amount (' + remaining.toFixed(2) + ' MAD)', '⚠️');
                return;
            }
            
            // If "Mark as fully paid" is checked, confirm with user
            if (markFullyPaid) {
                let confirmMsg;
                if (finalAmount > 0) {
                    // Worker is adding a partial payment AND marking as fully paid
                    confirmMsg = `Add ${finalAmount.toFixed(2)} MAD and mark as fully paid?\n\nClient cannot pay the remaining ${(remaining - finalAmount).toFixed(2)} MAD.\nThis will close the payment.`;
                } else {
                    // Worker is just marking as fully paid with no additional payment
                    confirmMsg = `Mark this payment as fully paid?\n\nClient cannot pay the remaining ${remaining.toFixed(2)} MAD.\nThis will close the payment.`;
                }
                
                const confirmed = await customConfirm(confirmMsg, '⚠️');
                if (!confirmed) {
                    return; // User cancelled
                }
            }
            
            // Add payment to array (only if amount > 0)
            if (!submission.payments) submission.payments = [];
            if (finalAmount > 0) {
                submission.payments.push({
                    amount: finalAmount,
                    date: Date.now()
                });
            }
            
            // Update total paid
            submission.totalPaid = totalPaid + finalAmount;
            
            // Update payment status
            if (markFullyPaid) {
                // Worker manually marked as fully paid (partial payment closed)
                submission.paymentStatus = 'fully_paid';
                // DON'T change totalPaid - keep actual amount paid!
                
                // Add note explaining why payment was closed early
                const waived = totalAmount - submission.totalPaid;
                submission.fullyPaidNote = t('worker_marked_paid') + ' - ' + t('cannot_pay_remaining').replace('{amount}', waived.toFixed(2));
            } else if (submission.totalPaid >= totalAmount - 0.01) {
                // Payment is actually complete (100%)
                submission.paymentStatus = 'fully_paid';
                submission.totalPaid = totalAmount; // Set to exact total amount to avoid rounding errors
            } else if (submission.totalPaid > 0) {
                submission.paymentStatus = 'partially_paid';
            } else {
                submission.paymentStatus = 'unpaid';
            }
            
            // Save locally
            saveData(data);
            
            // Update Firebase
            try {
                const firebaseKey = findFirebaseKeyByTimestamp(submission.timestamp);
                console.log('📤 Attempting to sync payment to Firebase...');
                console.log('   Submission timestamp:', submission.timestamp);
                console.log('   Firebase key:', firebaseKey);
                
                if (firebaseKey) {
                    const submissionRef = window.firebaseRef(window.firebaseDB, 'submissions/' + firebaseKey);
                    const updateData = {
                        payments: submission.payments,
                        totalPaid: submission.totalPaid,
                        paymentStatus: submission.paymentStatus
                    };
                    console.log('   Update data:', updateData);
                    
                    await window.firebaseUpdate(submissionRef, updateData);
                    console.log('✅ Payment synced to Firebase successfully!');
                } else {
                    console.error('❌ No Firebase key found! Cannot sync to Firebase.');
                    await customAlert('⚠️ Warning: Payment saved locally but could not sync to admin. The submission might not have been sent to Firebase yet.', '⚠️');
                }
            } catch (error) {
                console.error('❌ Firebase sync error:', error);
                await customAlert('⚠️ Payment saved locally but sync failed: ' + error.message, '⚠️');
            }
            
            // Update UI
            renderSubmissionHistory();
            closePaymentModal();
            
            // Show success message
            if (submission.paymentStatus === 'fully_paid') {
                await customAlert('🎉 Payment added! This job is now FULLY PAID!', '🎉');
            } else {
                const newRemaining = totalAmount - submission.totalPaid;
                await customAlert('✅ Payment of ' + amount.toFixed(2) + ' MAD added!\nRemaining: ' + newRemaining.toFixed(2) + ' MAD', '✅');
            }
        }

        function findFirebaseKeyByTimestamp(timestamp) {
            const data = loadData();
            const submission = data.submissions.find(s => s.timestamp === timestamp);
            const key = submission ? submission.firebaseKey : null;
            console.log('🔑 Finding Firebase key for timestamp:', timestamp, '→', key);
            return key;
        }

        // ========================================
        // ✏️ EDIT SESSION FEATURE (FEATURE 1)
        // ========================================
        
        let currentEditIndex = null;

        function editHistory(index) {
            const data = loadData();
            const session = data.history[index];
            
            if (!session) {
                return;
            }
            
            // Check if already sent
            if (session.sent === true) {
                customAlert('⚠️ Cannot edit: This session has already been submitted to admin.', '⚠️');
                return;
            }
            
            currentEditIndex = index;
            
            // Populate modal with current values
            document.getElementById('edit-job-site').value = session.jobSite || session.job || '';
            document.getElementById('edit-client-name').value = session.clientName || session.job || '';
            document.getElementById('edit-hourly-rate').value = session.rate || '';
            
            // Convert ISO timestamps to HH:MM format
            const startDate = new Date(session.startTime);
            const endDate = new Date(session.endTime);
            
            if (timeFormat === '12h') {
                // 12-hour format with AM/PM
                const startResult = formatTimeTo12Hour(startDate);
                const endResult = formatTimeTo12Hour(endDate);
                
                document.getElementById('edit-start-time').value = startResult.time;
                document.getElementById('edit-start-period').value = startResult.period;
                
                document.getElementById('edit-stop-time').value = endResult.time;
                document.getElementById('edit-stop-period').value = endResult.period;
            } else {
                // 24-hour format
                document.getElementById('edit-start-time').value = formatTimeToHHMM(startDate);
                document.getElementById('edit-stop-time').value = formatTimeToHHMM(endDate);
            }
            
            // Show calculated result
            document.getElementById('edit-duration-display').textContent = formatHM(session.duration);
            document.getElementById('edit-payment-display').textContent = session.payment + ' MAD';
            document.getElementById('edit-calculated-result').style.display = 'block';
            
            // Show modal
            document.getElementById('editSessionModal').style.display = 'flex';
            
            // Add auto-calculation on input change
            setupEditAutoCalculation();
        }

        function formatTimeToHHMM(date) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return hours + ':' + minutes;
        }

        function formatTimeTo12Hour(date) {
            let hours = date.getHours();
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const period = hours >= 12 ? 'PM' : 'AM';
            
            // Convert to 12-hour format
            if (hours === 0) {
                hours = 12;
            } else if (hours > 12) {
                hours = hours - 12;
            }
            
            const time = String(hours).padStart(2, '0') + ':' + minutes;
            return { time, period };
        }

        function setupEditAutoCalculation() {
            const inputs = ['edit-job-site', 'edit-client-name', 'edit-hourly-rate', 'edit-start-time', 'edit-stop-time'];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                el.removeEventListener('input', recalculateEditSession); // Prevent duplicates
                el.addEventListener('input', recalculateEditSession);
            });
            
            // Also listen to AM/PM dropdowns
            const editStartPeriod = document.getElementById('edit-start-period');
            const editStopPeriod = document.getElementById('edit-stop-period');
            
            if (editStartPeriod) {
                editStartPeriod.removeEventListener('change', recalculateEditSession);
                editStartPeriod.addEventListener('change', recalculateEditSession);
            }
            
            if (editStopPeriod) {
                editStopPeriod.removeEventListener('change', recalculateEditSession);
                editStopPeriod.addEventListener('change', recalculateEditSession);
            }
        }

        function recalculateEditSession() {
            const jobSite = document.getElementById('edit-job-site').value.trim();
            const clientName = document.getElementById('edit-client-name').value.trim();
            const rate = parseFloat(document.getElementById('edit-hourly-rate').value);
            let startTime = document.getElementById('edit-start-time').value.trim();
            let stopTime = document.getElementById('edit-stop-time').value.trim();
            
            if (!jobSite || !clientName || !rate || !startTime || !stopTime) {
                return;
            }
            
            // If 12-hour format, convert based on AM/PM selection
            if (timeFormat === '12h') {
                const startPeriod = document.getElementById('edit-start-period').value;
                const stopPeriod = document.getElementById('edit-stop-period').value;
                
                startTime = convertTo24Hour(startTime, startPeriod);
                stopTime = convertTo24Hour(stopTime, stopPeriod);
            }
            
            // Validate time format
            const timeRegex = /^([0-1][0-9]|2[0-3]):([0-5][0-9])$/;
            if (!timeRegex.test(startTime) || !timeRegex.test(stopTime)) {
                return;
            }
            
            // Get the original session's date
            const data = loadData();
            const originalSession = data.history[currentEditIndex];
            const originalDate = new Date(originalSession.endTime);
            const year = originalDate.getFullYear();
            const month = String(originalDate.getMonth() + 1).padStart(2, '0');
            const day = String(originalDate.getDate()).padStart(2, '0');
            const dateString = year + '-' + month + '-' + day;
            
            // Combine date with new times
            const start = new Date(dateString + 'T' + startTime);
            let stop = new Date(dateString + 'T' + stopTime);
            
            // If stop time is before start time, assume it's next day
            if (stop <= start) {
                stop.setDate(stop.getDate() + 1);
            }
            
            const durationSeconds = Math.floor((stop - start) / 1000);
            const payment = calculatePayment(durationSeconds, rate);
            
            // Update display
            document.getElementById('edit-duration-display').textContent = formatHM(durationSeconds);
            document.getElementById('edit-payment-display').textContent = payment + ' MAD';
            document.getElementById('edit-calculated-result').style.display = 'block';
        }

        async function saveEditedSession() {
            if (currentEditIndex === null) {
                return;
            }
            
            const jobSite = document.getElementById('edit-job-site').value.trim();
            const clientName = document.getElementById('edit-client-name').value.trim();
            const rate = parseFloat(document.getElementById('edit-hourly-rate').value);
            let startTime = document.getElementById('edit-start-time').value.trim();
            let stopTime = document.getElementById('edit-stop-time').value.trim();
            
            if (!jobSite || !clientName || !rate || !startTime || !stopTime) {
                await customAlert('⚠️ Please fill all fields!', '⚠️');
                return;
            }
            
            // If 12-hour format, convert based on AM/PM selection
            if (timeFormat === '12h') {
                const startPeriod = document.getElementById('edit-start-period').value;
                const stopPeriod = document.getElementById('edit-stop-period').value;
                
                startTime = convertTo24Hour(startTime, startPeriod);
                stopTime = convertTo24Hour(stopTime, stopPeriod);
            }
            
            // Validate time format
            const timeRegex = /^([0-1][0-9]|2[0-3]):([0-5][0-9])$/;
            if (!timeRegex.test(startTime) || !timeRegex.test(stopTime)) {
                await customAlert('⚠️ Invalid time format. Use HH:MM format', '⚠️');
                return;
            }
            
            const data = loadData();
            const originalSession = data.history[currentEditIndex];
            
            // Get the original session's date
            const originalDate = new Date(originalSession.endTime);
            const year = originalDate.getFullYear();
            const month = String(originalDate.getMonth() + 1).padStart(2, '0');
            const day = String(originalDate.getDate()).padStart(2, '0');
            const dateString = year + '-' + month + '-' + day;
            
            // Combine date with new times
            const start = new Date(dateString + 'T' + startTime);
            let stop = new Date(dateString + 'T' + stopTime);
            
            // If stop time is before start time, assume it's next day
            if (stop <= start) {
                stop.setDate(stop.getDate() + 1);
            }
            
            const durationSeconds = Math.floor((stop - start) / 1000);
            const payment = calculatePayment(durationSeconds, rate);
            
            // Update session (preserve timestamp if it exists)
            const originalTimestamp = originalSession.timestamp || Date.now();
            data.history[currentEditIndex] = {
                timestamp: originalTimestamp,
                jobSite: jobSite,
                clientName: clientName,
                rate: rate,
                startTime: start.toISOString(),
                endTime: stop.toISOString(),
                duration: durationSeconds,
                payment: payment,
                sent: false // Keep as unsent
            };
            
            saveData(data);
            
            // Sync edited session to Firebase
            await window.saveDraftToFirebase(data.history[currentEditIndex]);
            
            // Update UI
            renderHistory();
            updateTodaySummary();
            updateSubmitSummary();
            
            // Close modal
            closeEditSessionModal();
            
            await customAlert('✅ Session updated successfully!', '✅');
        }

        function closeEditSessionModal() {
            document.getElementById('editSessionModal').style.display = 'none';
            currentEditIndex = null;
        }

        // Auto-format time inputs in edit modal
        document.getElementById('edit-start-time').addEventListener('input', function() {
            formatTimeInput(this);
        });

        document.getElementById('edit-stop-time').addEventListener('input', function() {
            formatTimeInput(this);
        });

        // ========================================
        // 🕐 TIME FORMAT FEATURE (FEATURE 2)
        // ========================================
        
        let timeFormat = localStorage.getItem('timeFormat') || '24h';

        function setTimeFormat(format) {
            timeFormat = format;
            localStorage.setItem('timeFormat', format);
            
            // Update button styles
            const btn24h = document.getElementById('time-format-24h');
            const btn12h = document.getElementById('time-format-12h');
            
            if (format === '24h') {
                btn24h.style.background = '#2563eb';
                btn24h.style.color = 'white';
                btn24h.style.borderColor = '#2563eb';
                
                btn12h.style.background = 'white';
                btn12h.style.color = '#64748b';
                btn12h.style.borderColor = '#e2e8f0';
            } else {
                btn12h.style.background = '#2563eb';
                btn12h.style.color = 'white';
                btn12h.style.borderColor = '#2563eb';
                
                btn24h.style.background = 'white';
                btn24h.style.color = '#64748b';
                btn24h.style.borderColor = '#e2e8f0';
            }
            
            // Show/hide AM/PM dropdowns
            toggleAmPmDropdowns(format === '12h');
            
            // Re-render all time displays
            renderHistory();
            renderSubmissionHistory();
            
            console.log('🕐 Time format changed to:', format);
        }

        function toggleAmPmDropdowns(show) {
            // Manual Entry dropdowns
            const manualStartPeriod = document.getElementById('manual-start-period');
            const manualStopPeriod = document.getElementById('manual-stop-period');
            
            // Edit Session dropdowns
            const editStartPeriod = document.getElementById('edit-start-period');
            const editStopPeriod = document.getElementById('edit-stop-period');
            
            const displayValue = show ? 'block' : 'none';
            
            if (manualStartPeriod) manualStartPeriod.style.display = displayValue;
            if (manualStopPeriod) manualStopPeriod.style.display = displayValue;
            if (editStartPeriod) editStartPeriod.style.display = displayValue;
            if (editStopPeriod) editStopPeriod.style.display = displayValue;
        }

        function formatTimeDisplay(isoString) {
            const date = new Date(isoString);
            
            if (timeFormat === '12h') {
                // 12-hour format with AM/PM
                return date.toLocaleTimeString(currentLang === 'ar' ? 'ar-SA' : 'en-US', {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });
            } else {
                // 24-hour format
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return hours + ':' + minutes;
            }
        }

        // Initialize time format on page load
        function initializeTimeFormat() {
            setTimeFormat(timeFormat);
        }

        // ========================================
        // 💰 PRICE ADJUSTMENT FEATURE (FEATURE 3)
        // ========================================
        
        let currentPriceAdjustIndex = null;

        function showPriceAdjustModal(index) {
            const data = loadData();
            const session = data.history[index];
            
            if (!session) {
                return;
            }
            
            currentPriceAdjustIndex = index;
            
            const clientName = session.clientName || session.job || 'Unknown';
            const jobSite = session.jobSite || session.job || 'Unknown';
            const originalPrice = parseFloat(session.payment);
            const currentPrice = session.adjustedPrice !== undefined ? parseFloat(session.adjustedPrice) : originalPrice;
            
            // Populate modal
            document.getElementById('priceAdjustInfo').innerHTML = 
                '<div style="font-weight: 600; margin-bottom: 8px;">👤 ' + clientName + '</div>' +
                '<div style="font-size: 12px; color: #64748b; margin-bottom: 8px;">📍 ' + jobSite + '</div>' +
                '<div style="font-size: 12px; color: #64748b; margin-bottom: 5px;">' + formatHM(session.duration) + '</div>' +
                '<div style="border-top: 1px solid #e2e8f0; margin-top: 10px; padding-top: 10px;">' +
                '<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">' +
                '<strong>' + t('original_price') + '</strong>' +
                '<span style="color: #64748b;">' + originalPrice.toFixed(2) + ' MAD</span></div>' +
                (session.adjustedPrice !== undefined ? 
                    '<div style="display: flex; justify-content: space-between;">' +
                    '<strong>' + t('adjusted_price') + '</strong>' +
                    '<span style="color: #f59e0b; font-weight: 600;">' + currentPrice.toFixed(2) + ' MAD</span></div>' 
                    : '') +
                '</div>';
            
            document.getElementById('adjustedPriceInput').value = currentPrice.toFixed(2);
            document.getElementById('priceAdjustModal').style.display = 'flex';
        }

        function closePriceAdjustModal() {
            document.getElementById('priceAdjustModal').style.display = 'none';
            currentPriceAdjustIndex = null;
        }

        async function applyPriceAdjustment() {
            if (currentPriceAdjustIndex === null) {
                return;
            }
            
            const newPrice = parseFloat(document.getElementById('adjustedPriceInput').value);
            
            if (!newPrice || newPrice < 0) {
                await customAlert('⚠️ Please enter a valid price!', '⚠️');
                return;
            }
            
            const data = loadData();
            const session = data.history[currentPriceAdjustIndex];
            const originalPrice = parseFloat(session.payment);
            
            // Apply the adjusted price
            data.history[currentPriceAdjustIndex].adjustedPrice = newPrice.toFixed(2);
            
            saveData(data);
            updateSubmitSummary();
            closePriceAdjustModal();
            
            const diff = newPrice - originalPrice;
            const diffText = diff >= 0 ? '+' + diff.toFixed(2) : diff.toFixed(2);
            
            await customAlert('✅ Price adjusted!\n\nOriginal: ' + originalPrice.toFixed(2) + ' MAD\nNew: ' + newPrice.toFixed(2) + ' MAD\nDifference: ' + diffText + ' MAD', '✅');
        }

        async function resetPrice() {
            if (currentPriceAdjustIndex === null) {
                return;
            }
            
            const data = loadData();
            const session = data.history[currentPriceAdjustIndex];
            const originalPrice = parseFloat(session.payment);
            
            // Remove adjusted price (reset to original)
            delete data.history[currentPriceAdjustIndex].adjustedPrice;
            
            saveData(data);
            updateSubmitSummary();
            closePriceAdjustModal();
            
            await customAlert('✅ Price reset to original: ' + originalPrice.toFixed(2) + ' MAD', '✅');
        }
        
        // Disable service worker during development to avoid caching issues
        // if ('serviceWorker' in navigator) {
        //     navigator.serviceWorker.register('sw.js').catch(function() {});
        // }
    </script>
</body>
</html>
